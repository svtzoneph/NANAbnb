<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Notify | Zone Vault</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #050505; color: #ffffff;
            font-family: 'Outfit', sans-serif;
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; padding: 20px;
        }
        .admin-container {
            display: flex; flex-direction: column; gap: 20px;
            width: 100%; max-width: 600px;
        }
        .admin-box {
            background: #121212; border: 1px solid rgba(255,255,255,0.1);
            width: 100%; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        h2 { margin: 0 0 20px 0; font-weight: 700; color: #ef4444; display:flex; align-items:center; gap:10px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #a1a1aa; }
        input, textarea {
            width: 100%; background: #000; border: 1px solid rgba(255,255,255,0.1);
            color: #fff; padding: 12px; border-radius: 8px; font-family: inherit;
        }
        
        /* Icon Picker Grid */
        .icon-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;
            margin-top: 10px;
        }
        .icon-option {
            height: 40px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .icon-option:hover { background: #222; }
        .icon-option.selected { background: #fff; color: #000; }
        
        /* Buttons */
        .btn-primary {
            width: 100%; padding: 15px; background: #ef4444; color: white;
            border: none; border-radius: 50px; font-weight: 600; cursor: pointer;
            margin-top: 10px; transition: 0.2s;
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-cancel {
            width: 100%; padding: 10px; background: transparent; color: #a1a1aa;
            border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; 
            font-weight: 500; cursor: pointer; margin-top: 10px; display: none;
        }
        
        .success-msg { color: #22c55e; margin-top: 15px; text-align: center; display: none; }

        /* Existing List */
        .notif-list-container {
            margin-top: 20px; max-height: 300px; overflow-y: auto;
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;
        }
        .manage-item {
            background: rgba(255,255,255,0.03); border-radius: 10px; padding: 15px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .manage-info h4 { margin: 0 0 5px 0; font-size: 14px; color: #fff; }
        .manage-info p { margin: 0; font-size: 12px; color: #888; }
        .manage-actions { display: flex; gap: 10px; }
        .action-btn {
            width: 30px; height: 30px; border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn-edit { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .btn-delete { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .btn-edit:hover, .btn-delete:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<div class="admin-container">
    <div class="admin-box">
        <h2 id="formTitle"><i class="fas fa-shield-alt"></i> Create Notification</h2>
        
        <input type="hidden" id="editKey"> <div class="form-group">
            <label>Notification Title</label>
            <input type="text" id="notifTitle" placeholder="e.g. New Video Added">
        </div>
        
        <div class="form-group">
            <label>Message</label>
            <textarea id="notifMsg" rows="3" placeholder="e.g. Check out the new concert..."></textarea>
        </div>
        
        <div class="form-group">
            <label>Select Icon</label>
            <div class="icon-grid" id="iconGrid">
                <div class="icon-option selected" data-icon="fa-bell"><i class="fas fa-bell"></i></div>
                <div class="icon-option" data-icon="fa-video"><i class="fas fa-video"></i></div>
                <div class="icon-option" data-icon="fa-play-circle"><i class="fas fa-play-circle"></i></div>
                <div class="icon-option" data-icon="fa-music"><i class="fas fa-music"></i></div>
                <div class="icon-option" data-icon="fa-star"><i class="fas fa-star"></i></div>
                <div class="icon-option" data-icon="fa-exclamation-circle"><i class="fas fa-exclamation-circle"></i></div>
                
                <div class="icon-option" data-icon="fa-info-circle"><i class="fas fa-info-circle"></i></div>
                <div class="icon-option" data-icon="fa-fire"><i class="fas fa-fire"></i></div>
                <div class="icon-option" data-icon="fa-calendar"><i class="fas fa-calendar"></i></div>
                <div class="icon-option" data-icon="fa-check-circle"><i class="fas fa-check-circle"></i></div>
                <div class="icon-option" data-icon="fa-heart"><i class="fas fa-heart"></i></div>
                <div class="icon-option" data-icon="fa-wrench"><i class="fas fa-wrench"></i></div>
            </div>
        </div>
        
        <button id="submitBtn" class="btn-primary" onclick="handleSubmission()">Push Notification</button>
        <button id="cancelBtn" class="btn-cancel" onclick="resetForm()">Cancel Edit</button>
        
        <div id="status" class="success-msg">Success!</div>

        <div class="notif-list-container">
            <h3 style="font-size:14px; color:#666; margin-bottom:15px; text-transform:uppercase;">Active Notifications</h3>
            <div id="manageList">
                <div style="color:#444; font-size:12px; text-align:center;">Loading...</div>
            </div>
        </div>

        <div style="margin-top:20px; text-align:center;">
            <a href="home.html" style="color:#888; text-decoration:none; font-size:12px;">Back to Home</a>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
    // 1. Firebase Config
    const firebaseConfig = { apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0", authDomain: "tvnstream-b4497.firebaseapp.com", databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com", projectId: "tvnstream-b4497", storageBucket: "tvnstream-b4497.firebasestorage.app", messagingSenderId: "308384754214", appId: "1:308384754214:web:2938e76cd29b288f75d4e7" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. Icon Picker Logic
    let selectedIcon = 'fa-bell';
    const options = document.querySelectorAll('.icon-option');
    options.forEach(opt => {
        opt.addEventListener('click', () => {
            options.forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            selectedIcon = opt.getAttribute('data-icon');
        });
    });

    // 3. Load Existing Notifications
    const manageList = document.getElementById('manageList');
    db.ref('notifications').orderByKey().limitToLast(20).on('value', snapshot => {
        manageList.innerHTML = '';
        if(snapshot.exists()){
            const data = snapshot.val();
            // Convert to array [key, val] and reverse
            const items = Object.entries(data).reverse();
            
            items.forEach(([key, val]) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'manage-item';
                itemDiv.innerHTML = `
                    <div class="manage-info">
                        <h4><i class="fas ${val.icon} style="margin-right:5px;"></i> ${val.title}</h4>
                        <p>${val.message.substring(0, 30)}...</p>
                    </div>
                    <div class="manage-actions">
                        <button class="action-btn btn-edit" onclick="startEdit('${key}', '${val.title.replace(/'/g, "\\'")}', '${val.message.replace(/'/g, "\\'")}', '${val.icon}')">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteNotif('${key}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                manageList.appendChild(itemDiv);
            });
        } else {
            manageList.innerHTML = '<div style="color:#444; font-size:12px; text-align:center;">No notifications found.</div>';
        }
    });

    // 4. Submission Logic (Create or Update)
    function handleSubmission() {
        const title = document.getElementById('notifTitle').value;
        const msg = document.getElementById('notifMsg').value;
        const editKey = document.getElementById('editKey').value;
        
        if(!title || !msg) { alert("Please fill in all fields"); return; }
        
        const payload = {
            title: title,
            message: msg,
            icon: selectedIcon,
            timestamp: Date.now()
        };

        if (editKey) {
            // Update
            db.ref('notifications/' + editKey).update(payload).then(() => {
                showSuccess("Notification Updated!");
                resetForm();
            });
        } else {
            // Create New
            db.ref('notifications').push(payload).then(() => {
                showSuccess("Notification Sent!");
                resetForm();
            });
        }
    }

    // 5. Edit & Delete Helpers
    window.startEdit = function(key, title, msg, icon) {
        document.getElementById('editKey').value = key;
        document.getElementById('notifTitle').value = title;
        document.getElementById('notifMsg').value = msg;
        
        // Select icon visually
        selectedIcon = icon;
        options.forEach(o => {
            if(o.getAttribute('data-icon') === icon) o.classList.add('selected');
            else o.classList.remove('selected');
        });

        // UI Changes
        document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Notification';
        document.getElementById('submitBtn').innerText = 'Update Notification';
        document.getElementById('cancelBtn').style.display = 'block';
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.deleteNotif = function(key) {
        if(confirm("Are you sure you want to delete this notification?")) {
            db.ref('notifications/' + key).remove();
        }
    }

    window.resetForm = function() {
        document.getElementById('editKey').value = '';
        document.getElementById('notifTitle').value = '';
        document.getElementById('notifMsg').value = '';
        document.getElementById('formTitle').innerHTML = '<i class="fas fa-shield-alt"></i> Create Notification';
        document.getElementById('submitBtn').innerText = 'Push Notification';
        document.getElementById('cancelBtn').style.display = 'none';
        
        // Reset icon default
        selectedIcon = 'fa-bell';
        options.forEach(o => o.classList.remove('selected'));
        options[0].classList.add('selected');
    }

    function showSuccess(txt) {
        const status = document.getElementById('status');
        status.innerText = txt;
        status.style.display = 'block';
        setTimeout(() => status.style.display = 'none', 3000);
    }
</script>

<script>
  const allowedPaths = ['/index.html','/home.html','/nanabnb.html','/newtour.html','/hxwfanconcert.html','/svtholiday.html','/arenatour.html','/svtjapanconcert.html','/touragain.html','/gallery.html','/profile.html','/soon.html','/videos.html', '/admin.html'];
  const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
  const currentPage = window.location.pathname;
  let hasInternalAccess = sessionStorage.getItem('internalAccess') === 'true';
  const referrer = document.referrer;
  const refPath = referrer ? new URL(referrer, location.origin).pathname : null;
  const cameFromAllowedPage = refPath && allowedPaths.includes(refPath);
  if (cameFromAllowedPage || isAdmin) { sessionStorage.setItem('internalAccess', 'true'); hasInternalAccess = true; }
  const isIndexPage = currentPage.endsWith('index.html') || currentPage === '/';
  if (!hasInternalAccess && !isIndexPage && !isAdmin) { window.location.href = "index.html"; }
</script>
</body>
</html>
