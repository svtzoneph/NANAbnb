<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VIDEOS</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script> <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<link rel="icon" href="favicon-new.png" type="image/png" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<meta name="apple-mobile-web-app-title" content="Zone Vault">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" sizes="192x192" href="favicon-new.png">
<link rel="apple-touch-icon" sizes="512x512" href="favicon-new.png">
<link rel="apple-touch-startup-image" href="splash.png">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-1B2RJ659GL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1B2RJ659GL');
</script>

<script>
  (function() {
    const savedTheme = localStorage.getItem('zoneVaultTheme');
    if(savedTheme) {
      const style = document.createElement('style');
      style.innerHTML = `
        body { 
          background: ${savedTheme} !important; 
          background-size: cover !important;
          background-attachment: fixed !important;
          background-repeat: no-repeat !important;
          min-height: 100vh;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>

<style>
  /* --- CSS VARIABLES FOR GLASS --- */
  :root {
      --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      --glass-blur: blur(20px);
      --text-shadow: 0 1px 2px rgba(0,0,0,0.8);
      
      --plyr-color-main: gray;
      --plyr-control-bg: rgba(255,255,255,0.1);
      --plyr-control-hover-bg: rgba(255,255,255,0.2);
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: black; /* Fallback */
    text-align: center;
    padding: 20px 10px;
    margin: 0;
    transition: background 0.5s ease;
  }

  .main-layout {
    max-width: 1180px;
    margin: 0 auto;
    width: 100%;
    padding: 0 10px; 
  }

  .video-wrapper-left {
    width: 100%;
    position: relative; 
  }

  #poster-container {
    width: 100%;
    aspect-ratio: 16/9;
    background-size: cover;
    background-position: center;
    background-image: url('https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/inthesoop2.png'); 
    border-radius: 0px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    
    /* Poster Hyper Glass Border */
    box-shadow: var(--glass-shadow);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* --- GLASSMORPHISM POSTER OVERLAY --- */
  #poster-overlay {
    /* Hyper Glass Style */
    background: rgba(0, 0, 0, 0.5); 
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.5);
    
    padding: 15px 25px;
    border-radius: 50px;
    color: white;
    font-weight: bold;
    font-size: 18px;
    pointer-events: none; 
    max-width: 90%;
    text-align: center;
    margin: 0 auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    text-shadow: var(--text-shadow);
  }

  #player-container {
    display: none; 
    width: 100%;
    box-shadow: var(--glass-shadow);
  }

  h2 {
    font-size: 24px;
    color: white;
    margin-top: 15px;
    margin-bottom: 5px;
    font-weight: 500;
    letter-spacing: 0.5px;
    text-align: left; 
    text-shadow: var(--text-shadow);
  }

  h3.playlist-header {
    color: white; 
    margin-bottom: 10px; 
    font-size: 20px;
    text-shadow: var(--text-shadow);
  }

  @media (max-width: 600px) {
    h2 { font-size: 18px; }
    h3.playlist-header { 
        font-size: 16px; 
        margin-top: 20px; 
        opacity: 0.9;
    }
    #poster-overlay { 
        font-size: 14px; 
        padding: 10px 15px;
        border-radius: 35px;
        border-width: 1px;
    }
    .center-logo img { width: 40px; }
  }

  .center-logo { display: flex; justify-content: center; margin-bottom: 20px; }
  .center-logo img { width: 50px; height: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

  .plyr {
    width: 100%;
    aspect-ratio: 16/9;
    background: #000;
    border-radius: 0px;
    overflow: hidden;
  }
    
  video { width: 100%; }

  /* --- GLASSMORPHISM BACK BUTTON (Hyper) --- */
  .back-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px; height: 50px;
    
    /* Hyper Glass Style */
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.5);
    
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    text-decoration: none; z-index: 3000;
    transition: all 0.3s ease;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  }
  .back-btn:hover { 
    background: rgba(255,255,255,0.25); 
    transform: scale(1.1); 
    border-color: white;
  }
  .back-btn svg { display: block; }

  .plyr__captions {
    font-size: 18px;
    font-weight: bold;
    color: white;
    text-shadow: 5px 5px 14px black;
    padding: 4px 8px;
    bottom: 40px !important;
    text-align: center;
  }

  /* --- GLASSMORPHISM SEEK OVERLAY --- */
  .seek-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* Glass Style */
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    
    border-radius: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    z-index: 20; 
  }
  .seek-overlay.visible {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  .seek-overlay svg {
    width: 40px;
    height: 40px;
    fill: white;
    display: block;
  }
    
  /* Scrollbar Styling */
  #playlist-items::-webkit-scrollbar { width: 8px; }
  #playlist-items::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 4px; }
  #playlist-items::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 4px; border: 1px solid rgba(0,0,0,0.2); }
  #playlist-items::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }

  /* --- PLAYLIST ITEMS GLASS CLASS --- */
  .playlist-item {
      display: flex; 
      align-items: center; 
      gap: 15px; 
      padding: 10px;
      border-radius: 8px;
      transition: all 0.2s;
      
      /* Hyper Glass */
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      
      color: white;
      cursor: pointer;
  }
  .playlist-item:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  .playlist-item.locked {
      opacity: 0.5; 
      cursor: not-allowed; 
      filter: grayscale(1);
  }

  @media (min-width: 900px) {
    .main-layout {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 10px; 
      padding: 0 20px; 
      text-align: left;
    }
    .video-wrapper-left { flex: 2; }
    #playlist { flex: 1; margin-top: 0 !important; margin-bottom: 0 !important; max-width: none !important; }
    h3.playlist-header { margin-top: 0 !important; line-height: 1; }
    #playlist-items { max-height: 410px !important; padding-right: 10px; }
  }
</style>
</head>

<body>

<div class="center-logo">
  <img src="https://uploads.onecompiler.io/43ddry4jt/43s3sjvch/Zone%20Vault%20logo.png" alt="Zone Vault Logo">
</div>

<div class="main-layout">

  <div class="video-wrapper-left">
    
    <div id="poster-container">
      <div id="poster-overlay">Select an Episode to Watch</div>
    </div>

    <div id="player-container">
      <div class="plyr__video-wrapper">
        <video id="videoPlayer" playsinline controls crossorigin="anonymous"></video>
      </div>
    </div>

    <h2 id="main-title">Select Episode</h2>
  </div>

  <div id="playlist" style="width: 100%; max-width: 1000px; margin: 20px auto; text-align: left;">
    <h3 class="playlist-header">Other Episodes</h3>
    
    <div id="playlist-items" style="
        display: flex; 
        flex-direction: column; 
        gap: 10px;
        max-height: 410px; 
        overflow-y: auto; 
        padding-right: 10px;
    ">
    </div>
  </div>

</div> 

<script>
// --- 1. CONFIGURATION & DATA ---
// The "id" here is the unique number that will appear in the link (e.g., ?v=1)
// It MUST match the ID in your Firebase Database (inthesoop2/1)
const playlistData = [
  { 
    id: "1", 
    title: "EP1. READY TO TIME OFF", 
    image: "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/inthesoop2.png" 
  },
  { 
    id: "2", 
    title: "EP2. Thank you for your support", 
    image: "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/inthesoop2.png" 
  },
  { 
    id: "3", 
    title: "EP3. Your smile is the most brilliant thing in the world", 
    image: "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/inthesoop2.png" 
  },
  { 
    id: "4", 
    title: "EP4. It's been another exciting day.", 
    image: "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/inthesoop2.png" 
  },
  { 
    id: "5", 
    title: "EP5. ìš°ë¦¬ ì¶”ì–µ ë” ë°ê²Œ ë¹›ë‚˜ê³ ", 
    image: "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/inthesoop2.png" 
  },
  { 
    id: "6", 
    title: "EP6. Remember, We're Always Together", 
    image: "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/inthesoop2.png" 
  }
];

const playlistContainer = document.getElementById('playlist-items');
const posterContainer = document.getElementById('poster-container');
const playerContainer = document.getElementById('player-container');
const mainTitle = document.getElementById('main-title');

// Global variable to store current ep data
window.currentEpData = null;

// --- 2. CORE FUNCTION: PLAY EPISODE ---
// usage: loadAndPlayEpisode("1", true) -> true means update the URL
function loadAndPlayEpisode(epId, updateUrl = true) {
    // A. Find the episode
    const ep = playlistData.find(item => item.id === epId);
    
    if (!ep) {
        console.warn("Episode ID not found:", epId);
        return;
    }

    // B. Check Date Locking
    const today = new Date();
    if (ep.date) {
        const releaseDate = new Date(ep.date);
        if (releaseDate > today) {
            alert(`This episode is not yet available.\nRelease Date: ${ep.date}`);
            return; 
        }
    }

    // C. Update the Browser Link (The Unique URL part)
    // This creates links like: videos.html?v=1
    if (updateUrl) {
        const newUrl = window.location.pathname + '?v=' + ep.id;
        // pushState changes the URL without reloading the page
        history.pushState({id: ep.id}, '', newUrl);
    }

    // D. Set Data & UI
    window.currentEpData = ep;
    posterContainer.style.display = "none";
    playerContainer.style.display = "block";

    // E. Load Video from Firebase
    db.ref(`inthesoop2/${ep.id}`).once('value').then(snapshot => {
      const data = snapshot.val();
      if(!data || !data.url) { alert("Video unavailable"); return; }

      if(typeof hls !== 'undefined' && hls){ hls.destroy(); hls = null; }

      // Resume Logic
      const resumePlayback = () => {
          const user = auth.currentUser;
          if (!window.currentEpData || !user) {
             player.play(); 
             return;
          }
          db.ref('watchHistory/' + user.uid + '/' + window.currentEpData.id).once('value').then(snap => {
              const saved = snap.val();
              if (saved && saved.currentTime > 0) {
                  player.currentTime = saved.currentTime;
              }
              player.play();
          });
      };

      if(typeof Hls !== 'undefined' && Hls.isSupported()){
        hls = new Hls();
        hls.loadSource(data.url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => { 
             setTimeout(resumePlayback, 100);
        });
      } else {
        video.src = data.url;
        video.addEventListener('loadedmetadata', resumePlayback, { once: true });
      }

      // Subtitles
      video.querySelectorAll("track").forEach(t => t.remove());
      if(data.subtitles){
        Object.entries(data.subtitles).forEach(([lang,url])=>{
          const track = document.createElement("track");
          track.kind = "subtitles";
          track.label = lang.toUpperCase();
          track.srclang = lang;
          track.src = url;
          if(lang==="en") track.default = true;
          video.appendChild(track);
        });
      }
      
      // Title
      if(data.title){
        mainTitle.textContent = data.title;
      } else {
        mainTitle.textContent = ep.title;
      }

    }).catch(err => console.error("Firebase Error:", err));
}

// --- 3. HANDLE BROWSER BACK BUTTON ---
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.id) {
        // If user presses back, play the previous video WITHOUT adding to history stack again
        loadAndPlayEpisode(event.state.id, false);
    } else {
        // If back leads to the start, maybe show poster? 
        posterContainer.style.display = "flex";
        playerContainer.style.display = "none";
        player.pause();
    }
});

// --- 4. GENERATE PLAYLIST UI ---
playlistData.forEach(ep => {
  const epDiv = document.createElement('div');
  epDiv.className = 'playlist-item';
   
  const today = new Date();
  let isLocked = false;
  if (ep.date) {
      const releaseDate = new Date(ep.date);
      if (releaseDate > today) isLocked = true;
  }
  if (isLocked) epDiv.classList.add('locked');

  const thumb = document.createElement('img');
  thumb.src = ep.image;
  thumb.style.width = "120px";  
  thumb.style.height = "68px";   
  thumb.style.objectFit = "cover"; 
  thumb.style.borderRadius = "4px";
  
  const textDiv = document.createElement('div');
  textDiv.style.display = "flex";
  textDiv.style.flexDirection = "column"; 
  
  const title = document.createElement('span');
  title.textContent = ep.title;
  title.style.fontSize = "15px";
  title.style.fontWeight = "500";
  title.style.textShadow = "0 1px 2px rgba(0,0,0,0.8)";

  textDiv.appendChild(title);

  if (ep.date) {
      const dateSpan = document.createElement('span');
      dateSpan.textContent = isLocked ? `Available: ${ep.date}` : ep.date;
      dateSpan.style.fontSize = "12px";
      dateSpan.style.color = isLocked ? "#ff5252" : "#ccc";
      dateSpan.style.marginTop = "2px";
      dateSpan.style.textShadow = "0 1px 1px rgba(0,0,0,0.8)";
      textDiv.appendChild(dateSpan);
  }

  epDiv.appendChild(thumb);
  epDiv.appendChild(textDiv);

  // When clicked, play and update URL
  epDiv.addEventListener('click', () => {
    loadAndPlayEpisode(ep.id, true);
  });

  playlistContainer.appendChild(epDiv);
});

// --- 5. CHECK URL ON PAGE LOAD ---
window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const videoId = urlParams.get('v'); // Looks for ?v=1
    
    if (videoId) {
        // Delay slightly to ensure Firebase is ready
        setTimeout(() => {
            loadAndPlayEpisode(videoId, false); // false because URL is already there
        }, 500);
    }
});
</script>

<a href="videos.html" class="back-btn">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="white">
    <path d="M15 18l-6-6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</a>

<div id="rewind-icon-overlay" class="seek-overlay">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.9998 1.5V6.4428C5.5598 6.9048 2.4418 10.3368 2.4418 14.8828C2.4418 19.8288 6.4418 23.8288 11.3878 23.8288C15.8278 23.8288 19.4678 20.4968 20.0758 16.1988H17.5558C17.0098 18.9888 14.4838 21.3288 11.3878 21.3288C7.8118 21.3288 4.9418 18.4588 4.9418 14.8828C4.9418 11.6688 7.3738 9.0708 10.4998 8.6148V13.4998L17.4998 7.4998L9.9998 1.5Z"/></svg>
</div>
<div id="forward-icon-overlay" class="seek-overlay">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.0002 1.5L6.50016 7.49984L14.0002 13.4998V8.61484C17.1262 9.07084 19.5582 11.6688 19.5582 14.8828C19.5582 18.4588 16.6882 21.3288 13.1122 21.3288C10.0162 21.3288 7.49016 18.9888 6.94416 16.1988H4.42416C5.03216 20.4968 8.67216 23.8288 13.1122 23.8288C18.0582 23.8288 22.0582 19.8288 22.0582 14.8828C22.0582 10.3368 18.9402 6.90484 14.5002 6.44284V1.5Z"/></svg>
</div>
<div id="play-pause-icon-overlay" class="seek-overlay"></div>

<svg id="svg-play" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5.14V19.14L19 12.14L8 5.14Z"/></svg>
<svg id="svg-pause" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19H10V5H6V19ZM14 5V19H18V5H14Z"/></svg>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0",
  authDomain: "tvnstream-b4497.firebaseapp.com",
  databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com",
  projectId: "tvnstream-b4497",
  storageBucket: "tvnstream-b4497.appspot.com",
  messagingSenderId: "308384754214",
  appId: "1:308384754214:web:2938e76cd29b288f75d4e7",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(); // Initialized Auth
const db = firebase.database();

const video = document.getElementById("videoPlayer");
let hls;

const player = new Plyr(video, {
  captions: { active: true, update: true, language: "en" },
  controls: ["play-large","play","progress","current-time","duration","mute","settings","fullscreen"],
  settings: ["captions","speed","quality"],
  clickToPlay: false, 
  dblclickFullscreen: false
});

const isMobileOrTablet = /Mobi|Android|iPad|Tablet/i.test(navigator.userAgent);

function enterFullscreen(el) {
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  else if (el.msRequestFullscreen) el.msRequestFullscreen();
}

player.on('enterfullscreen', () => {
  if (isMobileOrTablet) {
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock('landscape').catch(err => {});
    } else if (window.screen.lockOrientation) {
      window.screen.lockOrientation('landscape');
    }
  }
});

player.on('exitfullscreen', () => {
  if (isMobileOrTablet) {
    if (screen.orientation && screen.orientation.unlock) {
      screen.orientation.unlock();
    }
  }
});

player.on('ready', () => {
    const videoContainer = player.elements.container;
    const videoWrapper = videoContainer.querySelector('.plyr__video-wrapper');
    if (!videoWrapper) return;

    const rewindIcon = document.getElementById('rewind-icon-overlay');
    const forwardIcon = document.getElementById('forward-icon-overlay');
    const playPauseIcon = document.getElementById('play-pause-icon-overlay');
    const playSvg = document.getElementById('svg-play') ? document.getElementById('svg-play').cloneNode(true) : null;
    const pauseSvg = document.getElementById('svg-pause') ? document.getElementById('svg-pause').cloneNode(true) : null;
    
    if(playSvg) playSvg.style.display = 'block';
    if(pauseSvg) pauseSvg.style.display = 'block';

    if (rewindIcon) videoWrapper.appendChild(rewindIcon);
    if (forwardIcon) videoWrapper.appendChild(forwardIcon);
    if (playPauseIcon) videoWrapper.appendChild(playPauseIcon);

    let lastTapTime = 0, tapTimeout = null, iconHideTimeout = null;

    function showSeekIcon(type) {
        if (iconHideTimeout) clearTimeout(iconHideTimeout);
        if(rewindIcon) rewindIcon.classList.remove('visible');
        if(forwardIcon) forwardIcon.classList.remove('visible');
        if(playPauseIcon) playPauseIcon.classList.remove('visible');

        let iconToShow;
        if (type === 'rewind') iconToShow = rewindIcon;
        else if (type === 'forward') iconToShow = forwardIcon;
        else if (type === 'play-pause') {
            iconToShow = playPauseIcon;
            if(playPauseIcon) {
                playPauseIcon.innerHTML = '';
                if (player.paused && pauseSvg) playPauseIcon.appendChild(pauseSvg); 
                else if (!player.paused && playSvg) playPauseIcon.appendChild(playSvg);
            }
        }
        if (iconToShow) {
            iconToShow.classList.add('visible');
            iconHideTimeout = setTimeout(() => { iconToShow.classList.remove('visible'); }, 500);
        }
    }

    function handleDoubleTap(event) {
        const rect = videoWrapper.getBoundingClientRect();
        const tapX = event.clientX - rect.left;
        const zoneWidth = rect.width;
        if (tapX < zoneWidth * 0.35) { player.rewind(10); showSeekIcon('rewind'); }
        else if (tapX > zoneWidth * 0.65) { player.forward(10); showSeekIcon('forward'); }
        else { showSeekIcon('play-pause'); player.togglePlay(); }
    }

    videoWrapper.addEventListener('click', (event) => {
        if (event.target.closest('.plyr__controls')) return;
        event.stopPropagation();
        const currentTime = new Date().getTime();
        const timeSinceLastTap = currentTime - lastTapTime;
        if (tapTimeout) { clearTimeout(tapTimeout); tapTimeout = null; }

        if (timeSinceLastTap > 0 && timeSinceLastTap < 300) {
            event.preventDefault(); handleDoubleTap(event); lastTapTime = 0;
        } else {
            event.preventDefault();
            tapTimeout = setTimeout(() => { player.toggleControls(); }, 300);
        }
        lastTapTime = currentTime;
    });

    videoWrapper.addEventListener('dblclick', (e) => { e.preventDefault(); e.stopPropagation(); });
});

// --- CLOUD SAVING LOGIC (SAVES TO FIREBASE) ---
let lastSaveTime = 0; // Throttle saves

player.on("timeupdate", () => {
    const user = auth.currentUser;
    
    // Check every 5 seconds (throttle) to avoid spamming DB
    const now = Date.now();
    if (user && window.currentEpData && !player.paused && player.currentTime > 5) {
        if (now - lastSaveTime > 5000) { // Save every 5s
            const dataToSave = {
                id: window.currentEpData.id,
                title: window.currentEpData.title,
                image: window.currentEpData.image,
                currentTime: player.currentTime,
                duration: player.duration || 0,
                timestamp: now
            };
            
            // Write to Cloud
            db.ref('watchHistory/' + user.uid + '/' + window.currentEpData.id).update(dataToSave);
            lastSaveTime = now;
        }
    }
});
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => {
      reg.onupdatefound = () => {
        const newSW = reg.installing;
        newSW.onstatechange = () => {
          if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
            window.location.reload();
          }
        };
      };
    }).catch(err => {});
  }
</script>

<style>
  /* Access Denied Modal - Hyper Glass */
  .access-denied-modal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.8); 
    color: #fff;
    font-family: 'Segoe UI', Arial, sans-serif;
    display: flex; align-items: center; justify-content: center;
    z-index: 9999; text-align: center; padding: 20px;
    opacity: 0; animation: fadeIn 0.5s forwards; flex-direction: column;
    backdrop-filter: blur(15px);
  }
  .access-denied-modal strong { font-size: 24px; margin-bottom: 10px; text-shadow: var(--text-shadow); }
  .access-denied-modal button {
    margin-top: 15px; padding: 10px 25px; 
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    color: white; border-radius: 50px;
    cursor: pointer; font-weight: bold; transition: all 0.3s ease;
    backdrop-filter: blur(5px);
  }
  .access-denied-modal button:hover { background: rgba(255,255,255,0.25); color: white; }
  @keyframes fadeIn { to { opacity: 1; } }
</style>

<script>
  const allowedPaths = [
    '/index.html', '/home.html', '/nanabnb.html', '/newtour.html',
    '/hxwfanconcert.html', '/svtholiday.html', '/arenatour.html',
    '/svtjapanconcert.html', '/touragain.html', '/gallery.html',
    '/profile.html', '/soon.html', '/videos.html'
  ];
  const currentPage = window.location.pathname;
  let hasInternalAccess = sessionStorage.getItem('internalAccess') === 'true';
  const referrer = document.referrer;
  const refPath = referrer ? new URL(referrer, location.origin).pathname : null;
  const cameFromAllowedPage = refPath && allowedPaths.includes(refPath);
  if (cameFromAllowedPage) { sessionStorage.setItem('internalAccess', 'true'); hasInternalAccess = true; }
  const isIndexPage = currentPage.endsWith('index.html') || currentPage === '/';
  if (!hasInternalAccess && !isIndexPage) { showAccessDeniedModal(); }
  function showAccessDeniedModal() {
    const modal = document.createElement('div');
    modal.className = 'access-denied-modal';
    modal.innerHTML = `<strong>ðŸš« Access Denied</strong><div>You cannot access this page directly.</div><div id="redirectTimer">Redirecting in 3 seconds...</div><button onclick="goBack()">Go Back</button>`;
    document.body.appendChild(modal);
    setTimeout(() => { window.location.href = "index.html"; }, 3000);
  }
  function goBack() { window.history.back(); }
</script>

</body>
</html>
