<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live | Zone Vault</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<link rel="icon" href="favicon-new.png" type="image/png" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<meta name="apple-mobile-web-app-title" content="Zone Vault">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" sizes="192x192" href="favicon-new.png">
<link rel="apple-touch-icon" sizes="512x512" href="favicon-new.png">
<link rel="apple-touch-startup-image" href="splash.png">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-1B2RJ659GL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1B2RJ659GL');
</script>

<script>
  (function() {
    const savedTheme = localStorage.getItem('zoneVaultTheme');
    if(savedTheme) {
      const style = document.createElement('style');
      style.innerHTML = `
        body { 
          background: ${savedTheme} !important; 
          background-size: cover !important;
          background-attachment: fixed !important;
          background-repeat: no-repeat !important;
          min-height: 100vh;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>

<style>
  /* --- CSS VARIABLES --- */
  :root {
      --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      --glass-blur: blur(20px);
      --text-shadow: 0 1px 2px rgba(0,0,0,0.8);
      --plyr-color-main: #ff0033; /* Red Accent */
  }

  * { box-sizing: border-box; }

  /* UPDATED: Reset margins */
  html, body {
    width: 100%;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
  }

  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: black; /* Fallback */
    text-align: center;
    padding-top: 20px; 
    padding-bottom: 20px;
    transition: background 0.5s ease;
  }

  .main-layout {
    max-width: 100%;
    margin: 0 auto;
    width: 100%;
    padding: 0 20px; 
  }

  .video-wrapper-left {
    width: 100%;
    position: relative; 
  }

  #poster-container {
    width: 100%;
    aspect-ratio: 16/9;
    background-size: cover;
    background-position: center;
    background-image: url('https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/new-tour.png'); 
    border-radius: 0px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    box-shadow: var(--glass-shadow);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* --- GLASSMORPHISM POSTER OVERLAY --- */
  #poster-overlay {
    background: rgba(0, 0, 0, 0.5); 
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.5);
    padding: 15px 25px;
    border-radius: 50px;
    color: white;
    font-weight: bold;
    font-size: 18px;
    pointer-events: none; 
    max-width: 90%;
    text-align: center;
    margin: 0 auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    text-shadow: var(--text-shadow);
    transform: translateZ(0);
    will-change: transform, backdrop-filter;
  }

  #player-container {
    display: none; 
    width: 100%;
    box-shadow: var(--glass-shadow);
    position: relative; 
  }

  h2 {
    font-size: 24px;
    color: white;
    margin-top: 15px;
    margin-bottom: 5px;
    font-weight: 500;
    letter-spacing: 0.5px;
    text-align: left; 
    text-shadow: var(--text-shadow);
  }

  h3.playlist-header {
    color: white; 
    margin-bottom: 10px; 
    font-size: 20px;
    text-shadow: var(--text-shadow);
  }

  /* --- MOBILE PORTRAIT (Standard View) --- */
  @media (max-width: 768px) {
    /* Keep padding in portrait so it doesn't touch edges */
    body { padding: 10px 0 !important; }
    .main-layout { padding: 0 15px !important; }
      
    h2 { font-size: 18px; }
    h3.playlist-header { 
        font-size: 16px; 
        margin-top: 20px; 
        opacity: 0.9;
    }
    #poster-overlay { 
        font-size: 14px; 
        padding: 10px 15px;
        border-radius: 35px;
        border-width: 1px;
    }
    .center-logo { margin-top: 15px; }
    .center-logo img { width: 40px; }
  }

  /* --- ðŸš€ MOBILE LANDSCAPE ONLY (TRUE FULLSCREEN FIX) --- */
  @media screen and (max-width: 915px) and (orientation: landscape) {
    /* 1. Force Video Container to be Fixed Position (On Top of Everything) */
    #player-container, #poster-container {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important; /* Highest priority */
        background: black !important;
        margin: 0 !important;
        border-radius: 0 !important;
        border: none !important;
    }

    /* 2. Make the Plyr Element fill that fixed container */
    .plyr {
        width: 100% !important;
        height: 100% !important;
    }
      
    /* 3. Ensure the video element itself stretches */
    video {
        width: 100% !important;
        height: 100% !important;
        object-fit: contain !important;
    }

    /* 4. Hide Header & Logo to clear view */
    .mobile-header, .center-logo {
        display: none !important;
    }

    /* 5. Push the rest of the content down so it doesn't hide behind the video (if user scrolls) */
    /* Note: Since video is fixed, content is behind it. We add padding to text elements just in case user exits fullscreen via gesture but keeps landscape */
    .video-wrapper-left {
        height: 100vh; /* Placeholder height */
    }
      
    #views-display, 
    #main-title, 
    #playlist {
        display: none !important; /* Optional: Hide details in landscape to mimic pure cinema mode */
    }
  }

  .center-logo { display: flex; justify-content: center; margin-bottom: 20px; }
  .center-logo img { width: 50px; height: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

  .plyr {
    width: 100%;
    aspect-ratio: 16/9;
    background: #000;
    border-radius: 0px;
    overflow: hidden;
  }
      
  video { width: 100%; }

  /* --- GLASSMORPHISM BACK BUTTON (Hyper) --- */
  .back-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px; height: 50px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    text-decoration: none; z-index: 3000;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    transform: translateZ(0);
    will-change: transform;
  }
  .back-btn:hover { 
    background: rgba(255,255,255,0.25); 
    transform: scale(1.1); 
    border-color: white;
  }
  .back-btn svg { display: block; }

/* --- REALISTIC STREAMING CONTROLS (Center Time / Mute Right) --- */
.plyr__controls {
  background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 40%, rgba(0,0,0,0) 100%) !important;
  padding: 20px 15px !important;
  display: flex !important;
  align-items: center;
  position: relative; /* Essential for absolute centering */
  z-index: 50 !important; /* Ensure controls are ABOVE the badge */
}

/* Push Mute & Friends to Right */
.plyr__volume {
   margin-left: auto !important;
}

/* Center Time & Duration (Absolute Positioning) */
.plyr__time {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-family: 'Roboto Mono', 'Courier New', monospace;
  font-weight: 700;
  font-size: 14px;
  color: rgba(255,255,255,0.95);
  text-shadow: 0 2px 2px rgba(0,0,0,0.8);
  pointer-events: none; 
  margin: 0 !important;
}

.plyr__time--current {
  left: 50%;
  transform: translate(-100%, -50%); 
  padding-right: 5px; 
}

.plyr__time--duration {
  left: 50%;
  transform: translate(0, -50%); 
  padding-left: 5px;
}

.plyr__time--duration::before {
  content: "/";
  position: absolute;
  left: -4px;
  color: rgba(255,255,255,0.5);
}

.plyr__control {
  background: transparent;
  border-radius: 8px !important;
  transition: transform 0.2s ease, background 0.2s ease;
  padding: 7px !important;
}
.plyr__control:hover {
  background: rgba(255, 255, 255, 0.2) !important;
  transform: scale(1.15);
}
.plyr__control svg {
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));
}

.plyr__control--overlaid {
  background: rgba(255, 255, 255, 0.1) !important;
  border: 1px solid rgba(255,255,255,0.4);
  backdrop-filter: blur(8px);
  width: 70px; height: 70px;
  box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}
.plyr__control--overlaid:hover {
  background: var(--plyr-color-main) !important;
  border-color: var(--plyr-color-main);
  transform: scale(1.1);
}

.plyr__captions {
  font-family: 'Segoe UI', sans-serif;
  font-size: 18px;
  font-weight: 600;
  text-shadow: 0 0 4px black, 0 0 8px black;
  padding-bottom: 60px !important; 
}
.plyr__caption { background: transparent !important; }

  /* --- GLASSMORPHISM SEEK OVERLAY --- */
  .seek-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    z-index: 20; 
    will-change: transform, opacity;
  }
  .seek-overlay.visible {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  .seek-overlay svg {
    width: 40px;
    height: 40px;
    fill: white;
    display: block;
  }
      
  /* Scrollbar Styling */
  #playlist-items::-webkit-scrollbar { width: 8px; }
  #playlist-items::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 4px; }
  #playlist-items::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 4px; border: 1px solid rgba(0,0,0,0.2); }
  #playlist-items::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }


  /* --- UPDATED CARD GRID (CUSTOM STYLE) --- */
  #playlist-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      padding-right: 5px;
      max-height: 500px;
      overflow-y: auto;
  }

  .playlist-card {
      background: linear-gradient(145deg, #222222, #1a1a1a);
      border-radius: 12px;
      padding: 22px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 180px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      transition: all 0.2s ease;
      position: relative;
      text-align: left;
  }

  .card-header {
      font-size: 17px;
      color: white; 
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 5px;
      padding-right: 0px; 
      margin-top: 35px; 
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  }

  .card-body {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-top: auto;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.05);
  }

  .date-info {
      text-align: left;
  }

  .date-main {
      font-size: 14px;
      font-weight: 600;
      color: #ccc;
      text-transform: uppercase;
      margin-bottom: 2px;
      display: block;
      letter-spacing: 0.5px;
  }

  .time-sub {
      font-size: 20px;
      font-weight: 800;
      color: white;
      display: block;
  }

  /* --- ACCOUNT VERIFIED BADGE --- */
  .ticket-status {
      position: absolute;
      top: 15px;
      left: 20px; 
      font-size: 11px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 4px 10px;
      border-radius: 20px;
      backdrop-filter: blur(5px);
  }

  .ticket-status.verified { 
      background: rgba(77, 184, 255, 0.15);
      color: #4db8ff; 
      border: 1px solid rgba(77, 184, 255, 0.3);
  }
   
  .ticket-status.denied { 
      background: rgba(255, 68, 68, 0.15);
      color: #ff4444; 
      border: 1px solid rgba(255, 68, 68, 0.3);
  }

  /* --- NEW: ENDED BADGE STYLE --- */
  .ticket-status.ended-badge {
      background: rgba(100, 100, 100, 0.15);
      color: #888;
      border: 1px solid rgba(100, 100, 100, 0.3);
  }

  .enter-btn {
      background: #333;
      color: #666;
      border: none;
      padding: 8px 20px;
      font-size: 13px;
      font-weight: 700;
      border-radius: 50px; 
      cursor: not-allowed;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      min-width: 90px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  }

  /* Active State */
  .enter-btn.active {
      background: white; 
      color: black;
      cursor: pointer;
  }

  .enter-btn.active:hover {
      background: #e0e0e0;
      transform: scale(1.05);
  }

  /* --- NEW: FINISHED EVENT BUTTON STYLE --- */
  .enter-btn.ended {
    background: #1a1a1a !important;
    color: #444 !important;
    border: 1px solid #333 !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
  }

  /* --- STATUS BADGE DESIGNS --- */
  .status-badge {
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 3px 8px;
    border-radius: 4px;
    margin-top: 6px;
    width: fit-content;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    transition: all 0.3s ease;
  }
   
  #player-status-badge.status-uid {
    position: absolute;
    top: auto !important;
    bottom: 15px !important;
    left: 15px !important;
    z-index: 1 !important;
    display: none;
    pointer-events: none;
     
    /* UPDATED STYLE: Transparent but Readable */
    font-size: 12px !important; 
    padding: 4px 10px !important;
     
    /* 1. Background: Almost invisible black tint for contrast */
    background: rgba(0, 0, 0, 0.2) !important; 
     
    /* 2. Color: White with 60% opacity (ghostly but visible) */
    color: rgba(255, 255, 255, 0.6) !important; 
     
    /* 3. Shadow: The secret to readability on any background */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8) !important;
     
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 6px;
    font-family: 'Roboto Mono', monospace;
    text-transform: none;
    backdrop-filter: blur(2px); /* Slight blur helps text pop */
  }

  .live-control-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(255, 0, 0, 0.15);
    border: 1px solid rgba(255, 0, 0, 0.4);
    color: #ff4444;
    font-size: 10px;
    font-weight: 800;
    padding: 2px 8px;
    border-radius: 4px;
    margin-left: 10px;
    pointer-events: none;
    height: 24px;
    user-select: none;
  }
  .live-dot {
    width: 6px;
    height: 6px;
    background: #ff4444;
    border-radius: 50%;
    box-shadow: 0 0 8px #ff4444;
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { transform: scale(0.95); opacity: 0.7; }
    50% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(0.95); opacity: 0.7; }
  }

  .player-overlay-title {
    position: absolute;
    top: 20px; 
    left: 0; 
    right: 0;
    text-align: center;
    color: white;
    font-size: 18px;
    font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    pointer-events: none;
    z-index: 100;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    padding: 0 60px;
  }
  .player-overlay-title.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .buffering-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 50;
    pointer-events: none;
    display: none;
  }
  .buffering-overlay.visible {
    display: block;
  }
  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--plyr-color-main);
    animation: spin 1s ease-in-out infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* --- UPDATED VIEWS & DATE CONTAINER --- */
  .views-container {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    margin-top: 15px; 
    margin-bottom: 5px;
    color: #a1a1a1;
    font-family: 'Segoe UI', sans-serif;
    font-size: 16px;
    font-weight: 500;
    opacity: 0; 
    transition: opacity 0.5s ease;
  }
  .views-container.visible {
    opacity: 1;
  }
  .views-icon {
    width: 18px;
    height: 18px;
    fill: #a1a1a1;
  }
  #current-date-display {
    margin-left: 5px;
    font-size: 14px;
    color: #666;
    font-weight: 400;
  }

  @media (max-width: 600px) {
    #player-status-badge.status-uid {
        font-size: 8px !important;
        bottom: 13px !important; /* Low on mobile too */
        left: 10px !important;
    }
    .player-overlay-title {
        font-size: 10px;
        top: 15px;
        padding: 0 40px;
    }
    .live-control-badge {
        font-size: 9px;
        padding: 1px 6px;
        height: 20px;
        margin-left: 6px;
    }
  }

  @media (min-width: 900px) {
    .main-layout {
      display: flex;
      flex-direction: column; 
      align-items: center;
      gap: 10px; 
      padding: 0 20px; 
      text-align: left;
    }
    .video-wrapper-left { width: 100%; max-width: 1100px; margin: 0 auto; }
      
    #playlist { 
        width: 100%; 
        max-width: 1100px; 
        margin: 20px auto !important; 
        text-align: left;
    }
      
    h3.playlist-header { margin-top: 0 !important; line-height: 1; }
    #playlist-items { 
        max-height: 500px !important; 
        padding-right: 10px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }
  }
</style>
</head>

<body>

<div class="center-logo">
  <img src="https://uploads.onecompiler.io/43ddry4jt/43s3sjvch/Zone%20Vault%20logo.png" loading="lazy" alt="Zone Vault Logo">
</div>

<div class="main-layout">

  <div class="video-wrapper-left">
      
    <div id="poster-container">
      <div id="poster-overlay">Select the Live to Watch</div>
    </div>

    <div id="player-container">
      <div id="player-status-badge" class="status-badge"></div>
      <div id="player-overlay-title" class="player-overlay-title"></div>
      
      <div id="buffering-overlay" class="buffering-overlay">
        <div class="spinner"></div>
      </div>
      
      <div class="plyr__video-wrapper">
        <video id="videoPlayer" playsinline controls crossorigin="anonymous"></video>
      </div>
    </div>

    <div id="views-display" class="views-container">
      <svg class="views-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <span id="view-count-text">0</span>
      <span id="current-date-display"></span>
    </div>

    <h2 id="main-title"></h2>
  </div>

  <div id="playlist" style="width: 100%; max-width: 1100px; margin: 20px auto; text-align: left;">
    <div id="playlist-items">
    </div>
  </div>

</div> 

<script>
// --- 1. CONFIGURATION & DATA ---
const playlistData = [
  { 
    id: "1", 
    title: "DAY 2 - SEVENTEEN WORLD TOUR [NEW_] IN JAPAN Osaka Show", 
    status: "Live",
    date: "December 14, 2025 8:30 AM",
    image: "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/new-tour.png",
  },
    { 
    id: "3", 
    title: "DAY 3 - SEVENTEEN WORLD TOUR [NEW_] IN JAPAN Osaka Show", 
    status: "TOMORROW",
    date: "December 14, 2025 2:30 PM",
    image: "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/new-tour.png",
  }
];

const playlistContainer = document.getElementById('playlist-items');
const posterContainer = document.getElementById('poster-container');
const playerContainer = document.getElementById('player-container');
const mainTitle = document.getElementById('main-title');
const playerBadge = document.getElementById('player-status-badge');
const overlayTitle = document.getElementById('player-overlay-title'); 
const currentDateDisplay = document.getElementById('current-date-display');

// NEW: Globals for Views and Buffering
const bufferingOverlay = document.getElementById('buffering-overlay');
const viewsDisplay = document.getElementById('views-display');
const viewCountText = document.getElementById('view-count-text');

let currentViewListenerRef = null;
let currentPresenceRef = null; 

// Global variable to store current ep data
window.currentEpData = null;
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0",
  authDomain: "tvnstream-b4497.firebaseapp.com",
  databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com",
  projectId: "tvnstream-b4497",
  storageBucket: "tvnstream-b4497.appspot.com",
  messagingSenderId: "308384754214",
  appId: "1:308384754214:web:2938e76cd29b288f75d4e7",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(); 
const db = firebase.database();

// =========================================================================
// !!! ðŸš¨ START OF PAGE-LEVEL SECURITY SCRIPT (REAL-TIME) ðŸš¨ !!!
// =========================================================================

const PAGE_ID = "jpnnewtour"; 

// --- SMART GO BACK FUNCTION (Centralized) ---
function smartGoBack() {
    if (document.referrer && window.history.length > 1) {
        window.history.back();
    } else {
        window.location.href = 'videos.html';
    }
}

// Function to show the denial screen
function showAccessDeniedModal(message) {
    if(typeof player !== 'undefined' && player) {
        player.pause();
        if(player.fullscreen.active) player.fullscreen.exit();
    }
    document.body.style.overflow = 'hidden';
    if(document.querySelector('.access-denied-modal')) return;

    const modal = document.createElement('div');
    modal.className = 'access-denied-modal';
    modal.style.opacity = '1';
    modal.style.animation = 'none';

    modal.innerHTML = `
        <strong style="color: #FF4444; font-size: 36px; margin-bottom: 20px;">Access Denied</strong>
        <div style="margin-top: 15px; font-size: 18px; max-width: 90%; line-height: 1.4; text-shadow: var(--text-shadow);">
            ${message}
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 30px; width: 80%; max-width: 300px;">
            <button onclick="smartGoBack()" 
                    style="background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3); color: white;">
                GO BACK
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

// Function to remove modal
function removeAccessDeniedModal() {
    const modal = document.querySelector('.access-denied-modal');
    if(modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
    }
}

// Check on page load AND listen for changes
auth.onAuthStateChanged(user => {
    if (!user) {
        showAccessDeniedModal("You must be logged in to view this content.");
        renderPlaylist(false); // Render playlist as Not Verified
        return;
    }

    // --- ðŸš¨ NEW: LINK OWNERSHIP CHECK ðŸš¨ ---
    const urlParams = new URLSearchParams(window.location.search);
    const linkUid = urlParams.get('uid'); // Get UID from URL

    // If the link has a UID, but it doesn't match the current logged-in user
    if (linkUid && linkUid !== user.uid) {
        showAccessDeniedModal(
            "<span style='color: #ff4444'>SECURITY ALERT</span><br><br>" +
            "This session link belongs to another user.<br>" +
            "Please return to the main menu and generate your own link."
        );
        return; // Stop execution
    }
    // ---------------------------------------

    // Set Badge UID
    if(playerBadge) {
        playerBadge.textContent = "ID: " + user.uid;
        playerBadge.style.display = "block"; 
        playerBadge.classList.add('status-uid');
    }

    // --- REALTIME LISTENER (.on instead of .once) ---
    const accessRef = db.ref(`page_access/${PAGE_ID}/${user.uid}`);
      
    accessRef.on('value', (snapshot) => {
        const isAllowed = snapshot.val();
        
        // --- 1. RENDER PLAYLIST BASED ON ACCESS ---
        renderPlaylist(isAllowed === true);
        
        // --- 2. HANDLE GLOBAL PAGE ACCESS ---
        if (isAllowed === true) {
            console.log("Access Granted/Verified for:", user.uid);
            removeAccessDeniedModal(); 

            // --- AUTO PLAY LOGIC MOVED HERE FOR SECURITY ---
            const videoId = urlParams.get('v'); 
            if (videoId && !window.currentEpData) {
                 setTimeout(() => { loadAndPlayEpisode(videoId, false); }, 500);
            }
        } else {
            // Immediate Block
            console.warn("Access Revoked in Realtime");
            showAccessDeniedModal(
                "<span style='color: red; font-weight: bold;'>You have violated Admin rules.</span><br>" +
                "Your access to this stream has been revoked.<br><br>" +
                "Please message us if you are sure this is an error.<br>" +
                "Your UID: <small>" + user.uid + "</small>"
            );
        }
    });
});
// =========================================================================
// !!! ðŸš¨ END OF PAGE-LEVEL SECURITY SCRIPT ðŸš¨ !!!
// =========================================================================

const video = document.getElementById("videoPlayer");
let hls;
let player = null;

// --- PLYR CONFIG ---
const defaultPlyrOptions = {
  captions: { active: true, update: true, language: "en" },
  controls: ['play-large', 'play', 'mute', 'settings', 'fullscreen'],
  settings: ["captions","speed","quality"],
  clickToPlay: false, 
  dblclickFullscreen: false,
  i18n: {
    quality: 'Quality',
    qualityBadge: { 2160: '4K', 1440: 'HD', 1080: 'HD', 720: 'HD', 576: 'SD', 480: 'SD' }
  }
};

// --- CORE FUNCTION: PLAY EPISODE ---
function loadAndPlayEpisode(epId, updateUrl = true) {
    const ep = playlistData.find(item => item.id === epId);
    
    if (!ep) { console.warn("Episode ID not found:", epId); return; }

    const today = new Date();
    if (ep.date) {
        const releaseDate = new Date(ep.date);
        if (releaseDate > today) {
            alert(`\nLIVE STREAM DATE: ${ep.date}`);
            return; 
        }
    }

    // --- GENERATE URL ---
    if (updateUrl && auth.currentUser) {
        const titleSlug = ep.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');
        const newUrl = window.location.pathname + `?v=${ep.id}&session=${Date.now()}&uid=${auth.currentUser.uid}&title=${titleSlug}`;
        history.pushState({id: ep.id, uid: auth.currentUser.uid}, '', newUrl);
    }

    // D. Set Data & UI
    window.currentEpData = ep;
    if(overlayTitle) overlayTitle.textContent = ep.title;

    posterContainer.style.display = "none";
    playerContainer.style.display = "block";

    // --- LIVE VIEWERS LOGIC ---
    const user = auth.currentUser;
    if (currentPresenceRef) { currentPresenceRef.remove(); currentPresenceRef.onDisconnect().cancel(); currentPresenceRef = null; }
    if (currentViewListenerRef) { currentViewListenerRef.off(); }

    if (user) {
        currentPresenceRef = db.ref(`active_viewers/${epId}/${user.uid}`);
        currentPresenceRef.onDisconnect().remove();
        currentPresenceRef.set({ timestamp: firebase.database.ServerValue.TIMESTAMP, device: navigator.userAgent });
    }

    currentViewListenerRef = db.ref(`active_viewers/${epId}`);
    currentViewListenerRef.on('value', (snapshot) => {
        const viewersData = snapshot.val();
        viewCountText.textContent = new Intl.NumberFormat().format(viewersData ? Object.keys(viewersData).length : 0);
        viewsDisplay.classList.add('visible');
    });

    db.ref(`live/${ep.id}`).once('value').then(snapshot => {
      const data = snapshot.val();
      if(!data || !data.url) { alert("Live unavailable"); return; }
      
      // CALL THE HELPER FUNCTION TO INITIALIZE HLS & PLYR
      setupStream(data.url, ep.status);

      if(data.title) { mainTitle.textContent = data.title; if(overlayTitle) overlayTitle.textContent = data.title; } 
      else { mainTitle.textContent = ep.title; }

    }).catch(err => console.error("Firebase Error:", err));
}

// --- 3. HELPER FUNCTION: SETUP STREAM (Hides HLS Complexity) ---
function setupStream(streamUrl, status) {
    
    const resumePlayback = () => {
        player.volume = 1; 
        player.muted = false; 
        updatePlayerLiveBadge(status);

        if (!window.currentEpData || !auth.currentUser) {
            player.play().catch(e => console.log("Autoplay blocked."));
            return;
        }
        db.ref('watchHistory/' + auth.currentUser.uid + '/' + window.currentEpData.id).once('value').then(snap => {
            const saved = snap.val();
            if (saved && saved.currentTime > 0) player.currentTime = saved.currentTime;
            player.play().catch(e => console.log("Autoplay blocked."));
        });
    };

    if(typeof Hls !== 'undefined' && Hls.isSupported()){
        if(hls) hls.destroy();
        hls = new Hls();
        hls.loadSource(streamUrl);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
            const availableQualities = hls.levels.map((l) => l.height);
            availableQualities.unshift(0);

            const newOptions = Object.assign({}, defaultPlyrOptions);
            newOptions.quality = {
                default: 0, 
                options: availableQualities,
                forced: true,
                onChange: (newQuality) => {
                    if (newQuality === 0) hls.currentLevel = -1; 
                    else hls.levels.forEach((level, idx) => { if (level.height === newQuality) hls.currentLevel = idx; });
                }
            };

            if(player) player.destroy();
            player = new Plyr(video, newOptions);
            attachPlayerEvents();
            setTimeout(resumePlayback, 100);
        });
    } else {
        video.src = streamUrl;
        if(player) player.destroy();
        player = new Plyr(video, defaultPlyrOptions);
        attachPlayerEvents();
        video.addEventListener('loadedmetadata', resumePlayback, { once: true });
    }
}

// --- HELPER: UPDATE LIVE BADGE IN PLAYER ---
function updatePlayerLiveBadge(status) {
    if (!player || !player.elements || !player.elements.controls) return;
    const controls = player.elements.controls;
    let badge = controls.querySelector('.live-control-badge');
    if(status && status.toUpperCase() === 'LIVE') {
        if(!badge) {
            badge = document.createElement('div');
            badge.className = 'live-control-badge';
            badge.innerHTML = '<span class="live-dot"></span>LIVE';
            const playBtn = controls.querySelector('[data-plyr="play"]');
            if(playBtn) playBtn.after(badge); else controls.insertBefore(badge, controls.firstChild);
        }
        badge.style.display = 'flex';
    } else { if(badge) badge.style.display = 'none'; }
}

// --- 4. HANDLE BROWSER BACK BUTTON ---
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.id) {
        loadAndPlayEpisode(event.state.id, false);
    } else {
        posterContainer.style.display = "flex";
        playerContainer.style.display = "none";
        if(player) player.pause();
    }
});

// --- 5. RENDER PLAYLIST UI ---
function renderPlaylist(isUserVerified) {
    playlistContainer.innerHTML = ''; 
    playlistData.forEach(ep => {
        const card = document.createElement('div');
        card.className = 'playlist-card';
        const today = new Date();
        let isDateLocked = false;
        if (ep.date && new Date(ep.date) > today) isDateLocked = true;

        let badgeHtml = '', buttonClass = 'enter-btn', buttonText = 'LOCKED', buttonDisabled = true;
        const isEnded = ep.status && (ep.status.toLowerCase() === 'ended' || ep.status.toLowerCase() === 'done');

        if (isEnded) {
            badgeHtml = `<div class="ticket-status ended-badge">EVENT ENDED</div>`;
            buttonText = 'ENDED'; buttonClass += ' ended'; buttonDisabled = true;
        } else if (isUserVerified) {
            badgeHtml = `<div class="ticket-status verified"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>ACCOUNT VERIFIED</div>`;
            if (!isDateLocked) { buttonClass += ' active'; buttonText = 'ENTER'; buttonDisabled = false; } 
            else { buttonClass += ' time-locked'; buttonText = 'WAITING'; }
        } else {
            badgeHtml = `<div class="ticket-status denied"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>ACCOUNT NOT VERIFIED</div>`;
            buttonText = 'NO ACCESS';
        }

        let displayDate = "COMING SOON", displayTime = "";
        if(ep.date) {
            const d = new Date(ep.date);
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'], months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            displayDate = `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;
            let h = d.getHours(), m = d.getMinutes(), ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12; h = h ? h : 12; m = m < 10 ? '0'+m : m;
            displayTime = h + ':' + m + ' ' + ampm + " PHT";
        }

        card.innerHTML = `${badgeHtml}<div class="card-header">${ep.title}</div><div class="card-body"><div class="date-info"><span class="date-main">${displayDate}</span><span class="time-sub">${displayTime}</span></div><button class="${buttonClass}" data-unlock-time="${ep.date}" data-id="${ep.id}" data-verified="${isUserVerified}" data-ended="${isEnded}" ${buttonDisabled ? 'disabled' : ''}>${buttonText}</button></div>`;
        
        card.querySelector('button').addEventListener('click', (e) => {
            const isVerified = e.target.getAttribute('data-verified') === 'true';
            const isEventEnded = e.target.getAttribute('data-ended') === 'true';
            const unlockTime = e.target.getAttribute('data-unlock-time') ? new Date(e.target.getAttribute('data-unlock-time')) : new Date();
            
            if (isEventEnded) return;
            if (!isVerified) { alert("Access Denied: Your account is not verified for this event."); return; }
            if (new Date() >= unlockTime) { loadAndPlayEpisode(ep.id, true); document.querySelector('.video-wrapper-left').scrollIntoView({ behavior: 'smooth' }); } 
            else { alert("Event has not started yet. Please wait."); }
        });
        playlistContainer.appendChild(card);
    });
}

function startGlobalTimer() {
    setInterval(() => {
        const now = new Date();
        document.querySelectorAll('.enter-btn.time-locked').forEach(btn => {
            if (btn.getAttribute('data-unlock-time') && now >= new Date(btn.getAttribute('data-unlock-time'))) {
                btn.textContent = 'ENTER'; btn.classList.remove('time-locked'); btn.classList.add('active'); btn.disabled = false;
            }
        });
        if(currentDateDisplay) currentDateDisplay.textContent = " â€¢ " + now.toLocaleTimeString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
    }, 1000);
}
startGlobalTimer();

const isMobileOrTablet = /Mobi|Android|iPad|Tablet/i.test(navigator.userAgent);

// --- WRAPPED EVENTS FUNCTION ---
function attachPlayerEvents() {
    if(!player) return;
    player.on('enterfullscreen', () => { if (isMobileOrTablet && screen.orientation) screen.orientation.lock('landscape').catch(()=>{}); });
    player.on('exitfullscreen', () => { if (isMobileOrTablet && screen.orientation) screen.orientation.unlock(); });
    player.on('waiting', () => { if (bufferingOverlay) bufferingOverlay.classList.add('visible'); });
    player.on('playing', () => { if (bufferingOverlay) bufferingOverlay.classList.remove('visible'); });
    player.on('pause', () => { if (bufferingOverlay) bufferingOverlay.classList.remove('visible'); });
    player.on('canplay', () => { if (bufferingOverlay) bufferingOverlay.classList.remove('visible'); });

    player.on('ready', () => {
        const videoWrapper = player.elements.container.querySelector('.plyr__video-wrapper');
        if (!videoWrapper) return;
        const badge = document.getElementById('player-status-badge'), overlayTitle = document.getElementById('player-overlay-title'), buffer = document.getElementById('buffering-overlay');
        if(badge) videoWrapper.appendChild(badge); if(overlayTitle) videoWrapper.appendChild(overlayTitle); if(buffer) videoWrapper.appendChild(buffer);
        player.on('controlsshown', () => { if(overlayTitle) overlayTitle.classList.add('visible'); });
        player.on('controlshidden', () => { if(overlayTitle && !player.paused) overlayTitle.classList.remove('visible'); });
        if(overlayTitle) overlayTitle.classList.add('visible');

        const rewindIcon = document.getElementById('rewind-icon-overlay'), forwardIcon = document.getElementById('forward-icon-overlay'), playPauseIcon = document.getElementById('play-pause-icon-overlay');
        if (rewindIcon) videoWrapper.appendChild(rewindIcon); if (forwardIcon) videoWrapper.appendChild(forwardIcon); if (playPauseIcon) videoWrapper.appendChild(playPauseIcon);

        let lastTapTime = 0, tapTimeout = null;
        const playSvg = document.getElementById('svg-play') ? document.getElementById('svg-play').cloneNode(true) : null;
        const pauseSvg = document.getElementById('svg-pause') ? document.getElementById('svg-pause').cloneNode(true) : null;
        if(playSvg) playSvg.style.display = 'block'; if(pauseSvg) pauseSvg.style.display = 'block';

        function showSeekIcon(type) {
            if(rewindIcon) rewindIcon.classList.remove('visible'); if(forwardIcon) forwardIcon.classList.remove('visible'); if(playPauseIcon) playPauseIcon.classList.remove('visible');
            let iconToShow = (type === 'rewind') ? rewindIcon : (type === 'forward') ? forwardIcon : playPauseIcon;
            if (type === 'play-pause' && playPauseIcon) {
                playPauseIcon.innerHTML = '';
                if (player.paused && pauseSvg) playPauseIcon.appendChild(pauseSvg); else if (!player.paused && playSvg) playPauseIcon.appendChild(playSvg);
            }
            if (iconToShow) { iconToShow.classList.add('visible'); setTimeout(() => iconToShow.classList.remove('visible'), 500); }
        }

        videoWrapper.addEventListener('click', (event) => {
            if (event.target.closest('.plyr__controls')) return;
            event.stopPropagation();
            const currentTime = new Date().getTime();
            if (currentTime - lastTapTime > 0 && currentTime - lastTapTime < 300) {
                if (tapTimeout) clearTimeout(tapTimeout);
                const tapX = event.clientX - videoWrapper.getBoundingClientRect().left;
                if (tapX < videoWrapper.getBoundingClientRect().width * 0.35) { player.rewind(10); showSeekIcon('rewind'); }
                else if (tapX > videoWrapper.getBoundingClientRect().width * 0.65) { player.forward(10); showSeekIcon('forward'); }
                else { showSeekIcon('play-pause'); player.togglePlay(); }
                lastTapTime = 0;
            } else {
                event.preventDefault(); tapTimeout = setTimeout(() => { player.toggleControls(); }, 300);
            }
            lastTapTime = currentTime;
        });
        videoWrapper.addEventListener('dblclick', (e) => { e.preventDefault(); e.stopPropagation(); });
    });

    let lastSaveTime = 0; 
    player.on("timeupdate", () => {
        const user = auth.currentUser;
        if (user && window.currentEpData && !player.paused && player.currentTime > 5 && Date.now() - lastSaveTime > 5000) { 
            let pageName = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1) || "videos.html"; 
            db.ref('watchHistory/' + user.uid + '/' + window.currentEpData.id).update({ id: window.currentEpData.id, title: window.currentEpData.title, image: window.currentEpData.image, currentTime: player.currentTime, duration: player.duration || 0, timestamp: Date.now(), page: pageName });
            lastSaveTime = Date.now();
        }
    });
}
window.addEventListener('beforeunload', () => { if (currentPresenceRef) currentPresenceRef.remove(); });
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => {
      reg.onupdatefound = () => {
        const newSW = reg.installing;
        newSW.onstatechange = () => { if (newSW.state === 'installed' && navigator.serviceWorker.controller) window.location.reload(); };
      };
    }).catch(err => {});
  }
</script>

<style>
  /* Access Denied Modal - Hyper Glass */
  .access-denied-modal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.85); 
    color: #fff;
    font-family: 'Segoe UI', Arial, sans-serif;
    display: flex; align-items: center; justify-content: center;
    z-index: 11000; text-align: center; padding: 20px;
    opacity: 0; animation: fadeIn 0.5s forwards; flex-direction: column;
    backdrop-filter: blur(15px);
    transform: translateZ(0);
    will-change: opacity, backdrop-filter;
  }
  .access-denied-modal strong { font-size: 24px; margin-bottom: 10px; text-shadow: var(--text-shadow); }
  .access-denied-modal button {
    margin-top: 15px; padding: 10px 25px; 
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    color: white; border-radius: 50px;
    cursor: pointer; font-weight: bold; transition: all 0.3s ease;
    backdrop-filter: blur(5px);
  }
  .access-denied-modal button:hover { background: rgba(255,255,255,0.25); color: white; }
  @keyframes fadeIn { to { opacity: 1; } }
</style>


<div id="rewind-icon-overlay" class="seek-overlay">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.9998 1.5V6.4428C5.5598 6.9048 2.4418 10.3368 2.4418 14.8828C2.4418 19.8288 6.4418 23.8288 11.3878 23.8288C15.8278 23.8288 19.4678 20.4968 20.0758 16.1988H17.5558C17.0098 18.9888 14.4838 21.3288 11.3878 21.3288C7.8118 21.3288 4.9418 18.4588 4.9418 14.8828C4.9418 11.6688 7.3738 9.0708 10.4998 8.6148V13.4998L17.4998 7.4998L9.9998 1.5Z"/></svg>
</div>
<div id="forward-icon-overlay" class="seek-overlay">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.0002 1.5L6.50016 7.49984L14.0002 13.4998V8.61484C17.1262 9.07084 19.5582 11.6688 19.5582 14.8828C19.5582 18.4588 16.6882 21.3288 13.1122 21.3288C10.0162 21.3288 7.49016 18.9888 6.94416 16.1988H4.42416C5.03216 20.4968 8.67216 23.8288 13.1122 23.8288C18.0582 23.8288 22.0582 19.8288 22.0582 14.8828C22.0582 10.3368 18.9402 6.90484 14.5002 6.44284V1.5Z"/></svg>
</div>
<div id="play-pause-icon-overlay" class="seek-overlay"></div>

<svg id="svg-play" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5.14V19.14L19 12.14L8 5.14Z"/></svg>
<svg id="svg-pause" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19H10V5H6V19ZM14 5V19H18V5H14Z"/></svg>

<script>
  const allowedPaths = [
    '/index.html',
    '/home.html',
    '/nanabnb.html',
    '/newtour.html',
    '/hxwfanconcert.html',
    '/svtholiday.html',
    '/arenatour.html',
    '/svtjapanconcert.html',
    '/touragain.html',
    '/gallery.html',
    '/profile.html',
    '/soon.html'
  ];

  const currentPage = window.location.pathname;

  let hasInternalAccess = sessionStorage.getItem('internalAccess') === 'true';

  const referrer = document.referrer;
  const refPath = referrer ? new URL(referrer).pathname : null;
  const cameFromAllowedPage = refPath && allowedPaths.includes(refPath);

  if (cameFromAllowedPage) {
    sessionStorage.setItem('internalAccess', 'true');
    hasInternalAccess = true;
  }
</script>

<script>
// Content Protection
document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
document.onkeydown = function(e) {
    if(e.keyCode == 123) return false;
    if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
    if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
    if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
    if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
}
window.ondragstart = function() { return false; } 
document.onselectstart = function() { return false; }
</script>

</body>
</html>
