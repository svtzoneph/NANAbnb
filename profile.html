<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="favicon-new.png" type="image/png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <meta name="apple-mobile-web-app-title" content="Zone Vault">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <link rel="apple-touch-icon" sizes="192x192" href="favicon-new.png">
  <link rel="apple-touch-icon" sizes="512x512" href="favicon-new.png">
  <link rel="apple-touch-startup-image" href="splash.png">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1B2RJ659GL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1B2RJ659GL');
  </script>
  
  <title>Profile | Zone Vault</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-color: #050505;
      --card-bg: #121212;
      --card-border: 1px solid rgba(255, 255, 255, 0.08);
      --accent: #2196f3;
      --text-main: #ffffff;
      --text-muted: #a1a1a1;
      --danger: #ef4444;
      --youtube-red: #ff0000;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    
    body { 
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- NAVIGATION --- */
    header {
      padding: 30px 20px 4px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 100;
      background: transparent;
      backdrop-filter: blur(6px);
      transition: transform 0.3s ease-in;
    }
    header.show { transform: translateY(0); }
    header.hide { transform: translateY(-100%); }

    .header-links {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex: 1;
      overflow-x: auto;
      white-space: nowrap;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      align-items: center;
    }

    .header-logo { width: 40px; height: auto; flex: 0 0 auto; }
    .header-logo img { width: 40px; height: auto; filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.5)); }

    .category-link {
      padding: 8px 16px;
      color: #fff;
      border-radius: 12px;
      font-size: 14px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    .category-link:hover { background: rgba(255,255,255,0.1); transform: scale(1.05); }
    .category-link.active { background: #fff; color: #000; }

    /* Mobile Nav */
    .mobile-header { display: none; }
    @media (max-width: 768px) {
      #scrollHeader { display: none; }
      .mobile-header {
        display: flex;
        padding: 10px 9px;
        align-items: center;
        justify-content: space-between;
        background: transparent;
        z-index: 1000;
      }
      .hamburger { font-size: 26px; background: none; border: none; color: white; cursor: pointer; }
    }

    .sidebar {
      display: flex; flex-direction: column;
      position: fixed; top: 0; left: -100%;
      width: 80%; max-width: 300px; height: 100%;
      background: black; backdrop-filter: blur(20px);
      z-index: 9999; padding: 20px; gap: 10px;
      transition: left 0.3s ease;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.6);
    }
    .sidebar.open { left: 0; }
    .sidebar .close-btn { align-self: flex-end; background: none; border: none; font-size: 26px; color: #fff; cursor: pointer; }
    .sidebar-title { font-size: 26px; font-weight: 700; text-align: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 10px; }
    .sidebar-nav { display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
    .sidebar-nav a { text-decoration: none; color: #fff; font-size: 15px; font-weight: 500; padding: 10px; border-radius: 6px; background: rgba(255, 255, 255, 0.05); }
    .sidebar-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
    .sidebar-logo img { width: 50px; height: auto; }
    .sidebar-email img { width: 30px; height: 30px; }

    /* --- PROFILE LAYOUT --- */
    .main-wrapper {
      max-width: 1000px;
      margin: 40px auto;
      width: 95%;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .profile-header-card {
      background: var(--card-bg);
      border: var(--card-border);
      border-radius: 16px;
      overflow: hidden;
      position: relative;
    }

    .banner-bg {
      height: 150px;
      width: 100%;
      background: linear-gradient(120deg, #1e3c72, #2a5298);
      background-size: cover;
      background-position: center;
      position: relative;
      transition: background 0.3s ease;
    }
    .banner-bg::after {
      content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 50%;
      background: linear-gradient(to top, var(--card-bg), transparent);
    }

    .profile-content {
      padding: 20px 30px 30px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: -60px;
    }

    .avatar-container { position: relative; margin-bottom: 15px; cursor: pointer; }
    .profile-img {
      width: 120px; height: 120px;
      border-radius: 50%;
      border: 4px solid var(--card-bg);
      object-fit: cover; background: #222;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      transition: filter 0.3s;
    }
    .avatar-container:hover .profile-img { filter: brightness(0.8); }

    .avatar-edit-badge {
      position: absolute; bottom: 5px; right: 5px;
      background: var(--accent);
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      border: 3px solid var(--card-bg); pointer-events: none;
    }

    .user-details { text-align: center; width: 100%; max-width: 500px; }
    
    #profile-display-view h1 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
    #profile-display-view p { color: var(--text-muted); font-size: 14px; margin-bottom: 15px; }
    
    .edit-btn {
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
        color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px;
        cursor: pointer; margin-top: 10px; transition: all 0.2s;
    }
    .edit-btn:hover { background: rgba(255,255,255,0.2); }

    #profile-edit-view {
        width: 100%; margin-top: 20px; background: rgba(255,255,255,0.03);
        padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
        display: none;
    }

    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; }
    .custom-input {
      width: 100%; background: #000; border: 1px solid #333;
      color: white; padding: 12px; border-radius: 8px; font-size: 14px;
    }
    
    .button-group { display: flex; gap: 10px; margin-top: 15px; }
    .primary-btn {
      flex: 1; padding: 12px; background: var(--accent); color: white;
      border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
    }
    .cancel-btn {
        flex: 1; padding: 12px; background: transparent; border: 1px solid #444;
        color: #ccc; border-radius: 8px; font-weight: 600; cursor: pointer;
    }
    .secondary-btn {
        width: 100%; padding: 10px; background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 8px;
        font-weight: 500; cursor: pointer; margin-top: 10px;
    }

    .notice-wrapper { position: absolute; top: 20px; right: 20px; z-index: 10; }
    #noticeBtn {
      background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1); width: 40px; height: 40px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: white;
    }

    .dashboard-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
    }
    .info-card {
      background: var(--card-bg); border: var(--card-border);
      border-radius: 16px; padding: 25px; display: flex; flex-direction: column;
    }
    .info-card h3 {
      font-size: 16px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);
      margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 10px;
      display: flex; align-items: center; gap: 10px;
    }
    .content-area { flex: 1; font-size: 14px; line-height: 1.6; }

    /* --- UPDATED HISTORY CARD STYLE --- */
    .history-card {
      display: flex; gap: 15px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px; overflow: hidden; margin-bottom: 15px;
      cursor: pointer; transition: background 0.2s; border: 1px solid transparent;
    }
    .history-card:hover {
      background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1);
    }

    .history-thumb-wrapper {
      position: relative; width: 140px; min-width: 140px; aspect-ratio: 16/9; background: #000;
    }
    .history-thumb-img { width: 100%; height: 100%; object-fit: cover; }
    
    .progress-bar-bg {
      position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.3);
    }
    .progress-bar-fill {
      height: 100%; width: 0%; background: var(--youtube-red); transition: width 0.3s;
    }
    .time-badge {
      position: absolute; bottom: 6px; right: 6px; background: rgba(0,0,0,0.85);
      color: white; font-size: 10px; font-weight: bold; padding: 2px 4px; border-radius: 4px;
    }

    .history-details {
      padding: 8px 8px 8px 0; display: flex; flex-direction: column; justify-content: center; flex: 1;
    }
    .history-title {
      font-size: 14px; font-weight: 600; color: white; margin-bottom: 4px;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .history-meta { font-size: 12px; color: #aaa; }
    .history-resume-text {
      font-size: 11px; color: var(--accent); margin-top: 4px; text-transform: uppercase;
      font-weight: bold; display: flex; align-items: center; gap: 5px;
    }

    .logout-btn {
      width: 100%; margin-top: 20px; padding: 14px; background: transparent;
      border: 1px solid var(--danger); color: var(--danger); font-weight: 600;
      border-radius: 8px; cursor: pointer;
    }

    @media (max-width: 600px) {
      .banner-bg { height: 120px; }
      .profile-content { margin-top: -50px; padding: 15px; }
      .profile-img { width: 100px; height: 100px; }
      .dashboard-grid { grid-template-columns: 1fr; }
      .history-thumb-wrapper { width: 120px; min-width: 120px; }
      .history-title { font-size: 13px; }
    }
    
    /* Access Denied Modal */
    .access-denied-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85); color: #fff;
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; text-align: center; padding: 20px;
      animation: fadeIn 0.5s forwards; flex-direction: column;
    }
    .access-denied-modal strong { font-size: 24px; margin-bottom: 10px; }
    .access-denied-modal button {
      margin-top: 15px; padding: 10px 25px; background: transparent;
      color: white; border: 2px solid white; border-radius: 50px;
      cursor: pointer; font-weight: bold;
    }
    @keyframes fadeIn { to { opacity: 1; } }
    
    /* Modals */
    #avatarModal, #bannerColorModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 10001; justify-content: center; align-items: center;
      backdrop-filter: blur(8px);
    }
    .avatar-modal-content, .banner-color-modal-content {
      background: #1a1a1a; padding: 25px; border-radius: 16px; width: 90%; max-width: 450px;
      border: 1px solid #333; text-align: center; max-height: 80vh; overflow-y: auto;
    }
    .avatar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
    .avatar-option {
      width: 100%; aspect-ratio: 1/1; border-radius: 50%; object-fit: cover;
      border: 2px solid transparent; cursor: pointer; transition: all 0.2s;
    }
    .avatar-option:hover { border-color: var(--accent); transform: scale(1.1); }

    .banner-color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
    .color-option {
        width: 100%; aspect-ratio: 1/1; border-radius: 8px; border: 2px solid transparent;
        cursor: pointer; transition: all 0.2s;
    }
    .color-option:hover { border-color: var(--accent); transform: scale(1.1); }
    .color-option.selected { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.5); }
  </style>
</head>
<body>
  
<div class="mobile-header">
  <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
</div>

<header id="scrollHeader">
  <div class="header-links">
    <div class="header-logo">
      <img src="https://uploads.onecompiler.io/43ddry4jt/43s3sjvch/Zone%20Vault%20logo.png" alt="Logo" />
    </div>
    <a class="category-link" href="index.html">LOGIN</a>
    <a class="category-link" href="home.html">HOME</a>
    <a class="category-link" href="live.html">LIVE</a>
    <a class="category-link" href="gallery.html">GALLERY</a>
    <a class="category-link" href="videos.html">VIDEOS</a>
  </div>
</header>

<div id="mobileSidebar" class="sidebar">
  <button class="close-btn" onclick="toggleSidebar()">‚úñ</button>
  <div class="sidebar-title">Zone Vault</div>
  <nav class="sidebar-nav">
    <a href="index.html">LOGIN</a>
    <a href="home.html">HOME</a>
    <a href="live.html">LIVE</a>
    <a href="gallery.html">GALLERY</a>
    <a href="videos.html">VIDEOS</a>
  </nav>
  <div class="sidebar-footer">
    <div class="sidebar-logo">
      <img src="https://uploads.onecompiler.io/43ddry4jt/43s3sjvch/Zone%20Vault%20logo.png" alt="Logo" />
    </div>
    <div class="sidebar-email">
      <a href="mailto:zonevaultph@gmail.com">
        <img src="https://uploads.onecompiler.io/43ddry4jt/43s3sjvch/letter.png" alt="Email" />
      </a>
    </div>
  </div>
</div>
  
  <div class="main-wrapper">

    <div class="profile-header-card">
      <div class="banner-bg" id="profile-banner">
        <div class="notice-wrapper">
          <button id="noticeBtn" title="View Notices">
            üîî
            <span id="noticeCount" style="
              position: absolute; top: 0; right: 0;
              background: var(--danger); color: white;
              border-radius: 50%; font-size: 10px; width: 16px; height: 16px;
              display: none; align-items: center; justify-content: center; border: 2px solid #121212;
            ">0</span>
          </button>
        </div>
      </div>

      <div class="profile-content">
        <div class="avatar-container" onclick="openAvatarModal()">
          <img id="profile-pic" class="profile-img" src="https://via.placeholder.com/120" alt="Profile" />
          <div class="avatar-edit-badge">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
          </div>
        </div>

        <div class="user-details">
          <p id="email" style="margin-bottom: 10px; font-size: 12px; opacity: 0.7;">Loading email...</p>

          <div id="profile-display-view">
              <h1 id="display-name">Loading...</h1>
              <p id="display-bio" style="font-style:italic;">...</p>
              <button onclick="toggleEditMode()" class="edit-btn">Edit Profile</button>
          </div>

          <div id="profile-edit-view">
            <div class="form-group">
              <label>Display Name</label>
              <input type="text" class="custom-input" id="nameInput" placeholder="Enter new name">
            </div>
            <div class="form-group">
              <label>Bio / Status</label>
              <textarea id="bioInput" class="custom-input" rows="2" placeholder="What's on your mind?"></textarea>
            </div>
            <button onclick="openBannerColorModal()" class="secondary-btn">Change Banner Theme</button>
            <div class="button-group">
                <button onclick="updateProfile()" class="primary-btn">Save</button>
                <button onclick="toggleEditMode()" class="cancel-btn">Cancel</button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="info-card">
        <h3>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          Continue Watching
        </h3>
        
        <div class="content-area" id="watched-list">
            <div style="color:#666; font-style:italic; padding:10px;">Syncing from cloud...</div>
        </div>
      </div>

      <div class="info-card">
        <h3>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          Join Status
        </h3>
        <div class="content-area" id="join-status">Checking...</div>
      </div>
    </div>

    <button onclick="logout()" class="logout-btn">Sign Out</button>

  </div>

  <div id="noticeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
    <div style="background: #1a1a1a; padding: 25px; border-radius: 16px; width: 90%; max-width: 450px; border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; font-size:18px;">Notifications</h2>
        <button id="closeNoticeModal" style="background:none; border:none; color:white; cursor:pointer; font-size:20px;">&times;</button>
      </div>
      <div id="noticeList" style="max-height:300px; overflow-y:auto;">Loading...</div>
    </div>
  </div>

  <div id="avatarModal">
    <div class="avatar-modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Choose Avatar</h3>
        <button onclick="closeAvatarModal()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">&times;</button>
      </div>
      <div class="avatar-grid" id="avatarGrid"></div>
    </div>
  </div>

  <div id="bannerColorModal">
    <div class="banner-color-modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Choose Banner Theme</h3>
        <button onclick="closeBannerColorModal()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">&times;</button>
      </div>
      <div class="banner-color-grid" id="bannerColorGrid"></div>
      <div class="button-group" style="margin-top: 20px;">
          <button onclick="saveBannerColor()" class="primary-btn">Apply Theme</button>
          <button onclick="closeBannerColorModal()" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0",
      authDomain: "tvnstream-b4497.firebaseapp.com",
      databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com",
      projectId: "tvnstream-b4497",
      storageBucket: "tvnstream-b4497.appspot.com",
      messagingSenderId: "308384754214",
      appId: "1:308384754214:web:2938e76cd29b288f75d4e7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // --- 1. AVATAR LOGIC ---
    const avatarOptions = [
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/scoups.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/jeonghan.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/joshua.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/jun.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/hoshi.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/wonwoo.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/woozi.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/dk.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/mingyu.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/the8.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/seungkwan.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/vernon.png", 
        "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/profile/dino.png", 
    ];

    function openAvatarModal() {
        const grid = document.getElementById('avatarGrid');
        grid.innerHTML = ''; 
        avatarOptions.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            img.className = 'avatar-option';
            img.onclick = () => selectAvatar(src);
            grid.appendChild(img);
        });
        document.getElementById('avatarModal').style.display = "flex";
    }

    function closeAvatarModal() {
        document.getElementById('avatarModal').style.display = "none";
    }

    function selectAvatar(url) {
        const user = auth.currentUser;
        if (!user) return;
        document.getElementById("profile-pic").src = url;
        db.ref("users/" + user.uid).update({ profilePicture: url }).then(() => {
            closeAvatarModal();
        });
    }

    // --- 2. BANNER COLOR LOGIC ---
    let tempSelectedBanner = null;
    const bannerOptions = [
        "linear-gradient(135deg, #F7CAC9, #92A8D1)", // Rose Quartz & Serenity
        "linear-gradient(120deg, #1e3c72, #2a5298)", // Default Blue
        "linear-gradient(120deg, #e65c00, #F9D423)", // Orange/Gold
        "linear-gradient(120deg, #cc2b5e, #753a88)", // Purple/Pink
        "linear-gradient(120deg, #11998e, #38ef7d)", // Green/Teal
        "linear-gradient(120deg, #000000, #434343)", // Black/Gray
        "linear-gradient(120deg, #8E2DE2, #4A00E0)", // Deep Purple
        "linear-gradient(120deg, #ee0979, #ff6a00)", // Hot Pink/Orange
    ];

    function openBannerColorModal() {
        const grid = document.getElementById('bannerColorGrid');
        grid.innerHTML = '';
        
        bannerOptions.forEach(color => {
            const div = document.createElement('div');
            div.className = 'color-option';
            div.style.background = color;
            div.onclick = () => {
                document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                div.classList.add('selected');
                tempSelectedBanner = color;
            };
            grid.appendChild(div);
        });
        
        document.getElementById('bannerColorModal').style.display = 'flex';
    }

    function closeBannerColorModal() {
        document.getElementById('bannerColorModal').style.display = 'none';
    }

    function saveBannerColor() {
        if(!tempSelectedBanner) {
            closeBannerColorModal();
            return;
        }
        
        const user = auth.currentUser;
        if(user) {
            document.getElementById('profile-banner').style.background = tempSelectedBanner;
            db.ref("users/" + user.uid).update({ bannerColor: tempSelectedBanner }).then(() => {
                closeBannerColorModal();
            });
        }
    }

    // --- NOTICE LOGIC ---
    document.addEventListener("DOMContentLoaded", () => {
      const noticeBtn = document.getElementById("noticeBtn");
      const noticeCount = document.getElementById("noticeCount");
      const noticeModal = document.getElementById("noticeModal");
      const noticeList = document.getElementById("noticeList");
      const closeNoticeModal = document.getElementById("closeNoticeModal");
      let unreadNotices = [];

      auth.onAuthStateChanged(user => {
        if (user) {
          const uid = user.uid;
          db.ref("notices").on("value", snapshot => {
            const allNotices = snapshot.val() || {};
            let userNotices = [];
            for (let id in allNotices) {
              const n = allNotices[id];
              if (n.to === uid || n.to === "ALL") {
                userNotices.push({ id, ...n });
              }
            }
            userNotices.sort((a, b) => b.timestamp - a.timestamp);
            unreadNotices = userNotices.filter(n => !n.read);

            if (unreadNotices.length > 0) {
              noticeCount.style.display = "flex";
              noticeCount.textContent = unreadNotices.length;
            } else {
              noticeCount.style.display = "none";
            }

            if (userNotices.length > 0) {
              noticeList.innerHTML = userNotices.map(n => `
                <div style="background:rgba(255,255,255,0.05); padding:12px; margin-bottom:10px; border-radius:8px; border-left: 3px solid ${n.read ? '#555' : '#2196f3'};">
                  <strong style="font-size:14px;">${n.title || "Notice"}</strong>
                  <div style="font-size:11px; color:#888; margin:2px 0 6px;">${new Date(n.timestamp).toLocaleString()}</div>
                  <p style="margin:0; font-size:13px; color:#ddd; line-height:1.4;">${n.message}</p>
                </div>
              `).join("");
            } else {
              noticeList.innerHTML = "<p style='text-align:center; color:#666;'>No notices available.</p>";
            }
          });

          noticeBtn.addEventListener("click", () => {
            noticeModal.style.display = "flex";
            unreadNotices.forEach(n => {
              db.ref(`notices/${n.id}/read`).set(true);
            });
            noticeCount.style.display = "none";
          });

          closeNoticeModal.addEventListener("click", () => {
            noticeModal.style.display = "none";
          });
        }
      });
    });

    // --- PROFILE & CLOUD HISTORY LOGIC ---
    auth.onAuthStateChanged(user => {
      if (user) {
        const uid = user.uid;
        document.getElementById('email').innerText = user.email;
        const userRef = db.ref("users/" + uid);

        userRef.once("value").then(snapshot => {
          const data = snapshot.val() || {};
          document.getElementById("profile-pic").src = data.profilePicture || "https://via.placeholder.com/120";
          if(data.bannerColor) {
              document.getElementById("profile-banner").style.background = data.bannerColor;
          }
          
          const displayName = data.name || "Zone Member";
          const displayBio = data.bio || "No bio yet.";
          
          document.getElementById("display-name").innerText = displayName;
          document.getElementById("display-bio").innerText = displayBio;
          document.getElementById("nameInput").value = data.name || "";
          document.getElementById("bioInput").value = data.bio || "";

          if(data.name) {
              showDisplayMode();
          } else {
              showEditMode();
          }
        });

        // --- WATCH HISTORY FROM FIREBASE CLOUD ---
        db.ref('watchHistory/' + uid).on('value', (snapshot) => {
            const historyContainer = document.getElementById("watched-list");
            const data = snapshot.val();
            
            if (data) {
                const historyItems = Object.values(data);
                historyItems.sort((a, b) => b.timestamp - a.timestamp);
                
                let historyHTML = "";
                
                historyItems.forEach(item => {
                     if (item.title && item.currentTime > 0) {
                         const minutes = Math.floor(item.currentTime / 60);
                         const seconds = Math.floor(item.currentTime % 60);
                         const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                         
                         let percent = 0;
                         if(item.duration && item.duration > 0) {
                             percent = (item.currentTime / item.duration) * 100;
                         }

                         // UPDATED LINK: passes specific episode ID
                         historyHTML += `
                            <div class="history-card" onclick="window.location.href='videos.html?id=${item.id}'">
                               <div class="history-thumb-wrapper">
                                   <img src="${item.image || 'https://via.placeholder.com/160x90'}" class="history-thumb-img" alt="${item.title}">
                                   <div class="progress-bar-bg">
                                      <div class="progress-bar-fill" style="width: ${percent}%"></div>
                                   </div>
                                   <div class="time-badge">${timeString}</div>
                               </div>
                               <div class="history-details">
                                   <div class="history-title">${item.title}</div>
                                   <div class="history-meta">Stopped at ${timeString}</div>
                                   <div class="history-resume-text">
                                      <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                      Resume
                                   </div>
                               </div>
                            </div>
                         `;
                     }
                });
                historyContainer.innerHTML = historyHTML || "<div style='color:#666; text-align:center; padding:10px;'>No history yet.</div>";
            } else {
                historyContainer.innerHTML = `
                    <div style="text-align:center; padding:30px; color:#666;">
                       <p style="margin-bottom:5px; font-size:14px;">No watch history found.</p>
                       <small style="font-size:12px; color:#444;">Watch a video to see it appear here!</small>
                    </div>
                `;
            }
        });

        // Join Status
        db.ref(`joinRequests/${uid}/status`).once("value").then(snapshot => {
          const status = snapshot.val();
          let color = "#aaa";
          if(status === "Approved") color = "#4caf50";
          if(status === "Pending") color = "#ff9800";
          
          document.getElementById("join-status").innerHTML = status 
            ? `<span style="color:${color}; font-weight:bold; font-size:16px;">‚óè ${status}</span>` 
            : "<span style='color:#666'>No request submitted.</span>";
        });

      } else {
        window.location.href = "index.html";
      }
    });

    // --- MODES ---
    function showDisplayMode() {
        document.getElementById('profile-display-view').style.display = 'block';
        document.getElementById('profile-edit-view').style.display = 'none';
    }
    function showEditMode() {
        document.getElementById('profile-display-view').style.display = 'none';
        document.getElementById('profile-edit-view').style.display = 'block';
    }
    function toggleEditMode() {
        const editView = document.getElementById('profile-edit-view');
        if (editView.style.display === 'none') showEditMode(); else showDisplayMode();
    }

    function updateProfile() {
      const user = auth.currentUser;
      if (!user) return;
      const btn = document.querySelector('.primary-btn');
      const originalText = btn.innerText;
      btn.innerText = "Saving...";
      const uid = user.uid;
      const name = document.getElementById("nameInput").value;
      const bio = document.getElementById("bioInput").value;
      const updates = {};
      if (name) updates.name = name;
      if (bio) updates.bio = bio;
      db.ref("users/" + uid).update(updates).then(() => {
        btn.innerText = "Saved!";
        document.getElementById("display-name").innerText = name;
        document.getElementById("display-bio").innerText = bio;
        setTimeout(() => {
            btn.innerText = originalText;
            showDisplayMode(); 
        }, 800);
      });
    }

    function logout() {
      if(confirm("Are you sure you want to log out?")) {
        auth.signOut().then(() => {
          window.location.href = "index.html";
        });
      }
    }
  </script>

  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('mobileSidebar');
      sidebar.classList.toggle('open');
    }
    let lastScrollY = window.scrollY;
    const scrollHeader = document.getElementById('scrollHeader');
    window.addEventListener('scroll', () => {
      const currentScrollY = window.scrollY;
      if (currentScrollY > lastScrollY && currentScrollY > 50) {
        scrollHeader.classList.add('hide');
      } else {
        scrollHeader.classList.remove('hide');
      }
      lastScrollY = currentScrollY;
    });
    const linksContainer = document.querySelector('.header-links');
    if(linksContainer) {
        linksContainer.addEventListener('wheel', (e) => {
          if (e.deltaY === 0) return;
          e.preventDefault();
          linksContainer.scrollBy({ left: e.deltaY < 0 ? -100 : 100 });
        });
    }
  </script>

<style>
  .access-denied-modal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.85); color: #fff;
    font-family: 'Segoe UI', Arial, sans-serif;
    display: flex; align-items: center; justify-content: center;
    z-index: 9999; text-align: center; padding: 20px;
    opacity: 0; animation: fadeIn 0.5s forwards; flex-direction: column;
  }
  .access-denied-modal strong { font-size: 24px; margin-bottom: 10px; }
  .access-denied-modal button {
    margin-top: 15px; padding: 10px 25px; background: transparent;
    color: white; border: 2px solid white; border-radius: 50px;
    cursor: pointer; font-weight: bold; transition: all 0.3s ease;
  }
  .access-denied-modal button:hover { background: white; color: black; }
  @keyframes fadeIn { to { opacity: 1; } }
</style>

<script>
  const allowedPaths = [
    '/index.html', '/home.html', '/nanabnb.html', '/newtour.html',
    '/hxwfanconcert.html', '/svtholiday.html', '/arenatour.html',
    '/svtjapanconcert.html', '/touragain.html', '/gallery.html',
    '/profile.html', '/soon.html', '/videos.html'
  ];
  const currentPage = window.location.pathname;
  let hasInternalAccess = sessionStorage.getItem('internalAccess') === 'true';
  const referrer = document.referrer;
  const refPath = referrer ? new URL(referrer, location.origin).pathname : null;
  const cameFromAllowedPage = refPath && allowedPaths.includes(refPath);
  if (cameFromAllowedPage) { sessionStorage.setItem('internalAccess', 'true'); hasInternalAccess = true; }
  const isIndexPage = currentPage.endsWith('index.html') || currentPage === '/';
  if (!hasInternalAccess && !isIndexPage) { showAccessDeniedModal(); }
  function showAccessDeniedModal() {
    const modal = document.createElement('div');
    modal.className = 'access-denied-modal';
    modal.innerHTML = `<strong>üö´ Access Denied</strong><div>You cannot access this page directly.</div><div id="redirectTimer">Redirecting in 3 seconds...</div><button onclick="goBack()">Go Back</button>`;
    document.body.appendChild(modal);
    setTimeout(() => { window.location.href = "index.html"; }, 3000);
  }
  function goBack() { window.history.back(); }
</script>

  <footer style="width: 100%; color: #444; padding: 30px 0; text-align: center; font-size: 12px; border-top: 1px solid #111; margin-top: 40px;">
    <p>&copy; 2025 Zone Vault. All rights reserved.</p>
  </footer>

</body>
</html>
