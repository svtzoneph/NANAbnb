<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VIDEOS</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script> <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<link rel="icon" href="favicon-new.png" type="image/png" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<meta name="apple-mobile-web-app-title" content="Zone Vault">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" sizes="192x192" href="favicon-new.png">
<link rel="apple-touch-icon" sizes="512x512" href="favicon-new.png">
<link rel="apple-touch-startup-image" href="splash.png">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-1B2RJ659GL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1B2RJ659GL');
</script>

<script>
  (function() {
    const savedTheme = localStorage.getItem('zoneVaultTheme');
    if(savedTheme) {
      const style = document.createElement('style');
      style.innerHTML = `
        body { 
          background: ${savedTheme} !important; 
          background-size: cover !important;
          background-attachment: fixed !important;
          background-repeat: no-repeat !important;
          min-height: 100vh;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>

<style>
  /* --- CSS VARIABLES FOR GLASS --- */
  :root {
      --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      --glass-blur: blur(20px);
      --text-shadow: 0 1px 2px rgba(0,0,0,0.8);
      
      --plyr-color-main: gray;
      --plyr-control-bg: rgba(255,255,255,0.1);
      --plyr-control-hover-bg: rgba(255,255,255,0.2);
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: black; /* Fallback */
    text-align: center;
    padding: 20px 10px;
    margin: 0;
    transition: background 0.5s ease;
  }

  .main-layout {
    max-width: 1180px;
    margin: 0 auto;
    width: 100%;
    padding: 0 10px; 
  }

  .video-wrapper-left {
    width: 100%;
    position: relative; 
  }

  #poster-container {
    width: 100%;
    aspect-ratio: 16/9;
    background-size: cover;
    background-position: center;
    background-image: url('https://uploads.onecompiler.io/43ddry4jt/43wkywbqe/Screenshot%202025-09-13%2021-01-14.png'); 
    border-radius: 0px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    
    /* Poster Hyper Glass Border */
    box-shadow: var(--glass-shadow);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* --- GLASSMORPHISM POSTER OVERLAY --- */
  #poster-overlay {
    /* Hyper Glass Style */
    background: rgba(0, 0, 0, 0.5); 
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.5);
    
    padding: 15px 25px;
    border-radius: 50px;
    color: white;
    font-weight: bold;
    font-size: 18px;
    pointer-events: none; 
    max-width: 90%;
    text-align: center;
    margin: 0 auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    text-shadow: var(--text-shadow);

    /* SMOOTHNESS BOOSTER */
    transform: translateZ(0);
    will-change: transform, backdrop-filter;
  }

  #player-container {
    display: none; 
    width: 100%;
    box-shadow: var(--glass-shadow);
  }

  h2 {
    font-size: 24px;
    color: white;
    margin-top: 15px;
    margin-bottom: 5px;
    font-weight: 500;
    letter-spacing: 0.5px;
    text-align: left; 
    text-shadow: var(--text-shadow);
  }

  h3.playlist-header {
    color: white; 
    margin-bottom: 10px; 
    font-size: 20px;
    text-shadow: var(--text-shadow);
  }

  @media (max-width: 600px) {
    h2 { font-size: 18px; }
    h3.playlist-header { 
        font-size: 16px; 
        margin-top: 20px; 
        opacity: 0.9;
    }
    #poster-overlay { 
        font-size: 14px; 
        padding: 10px 15px;
        border-radius: 35px;
        border-width: 1px;
    }
    .center-logo img { width: 40px; }
  }

  .center-logo { display: flex; justify-content: center; margin-bottom: 20px; }
  .center-logo img { width: 50px; height: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

  .plyr {
    width: 100%;
    aspect-ratio: 16/9;
    background: #000;
    border-radius: 0px;
    overflow: hidden;
  }
    
  video { width: 100%; }

  /* --- GLASSMORPHISM BACK BUTTON (Hyper) --- */
  .back-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px; height: 50px;
    
    /* Hyper Glass Style */
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.5);
    
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    text-decoration: none; z-index: 3000;
    transition: all 0.3s ease;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);

    /* SMOOTHNESS BOOSTER */
    transform: translateZ(0);
    will-change: transform;
  }
  .back-btn:hover { 
    background: rgba(255,255,255,0.25); 
    transform: scale(1.1); 
    border-color: white;
  }
  .back-btn svg { display: block; }

  .plyr__captions {
    font-size: 18px;
    font-weight: bold;
    color: white;
    text-shadow: 5px 5px 14px black;
    padding: 4px 8px;
    bottom: 40px !important;
    text-align: center;
  }

  /* --- GLASSMORPHISM SEEK OVERLAY --- */
  .seek-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* Glass Style */
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    
    border-radius: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    z-index: 20; 

    /* SMOOTHNESS BOOSTER */
    will-change: transform, opacity;
  }
  .seek-overlay.visible {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  .seek-overlay svg {
    width: 40px;
    height: 40px;
    fill: white;
    display: block;
  }
    
  /* Scrollbar Styling */
  #playlist-items::-webkit-scrollbar { width: 8px; }
  #playlist-items::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 4px; }
  #playlist-items::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 4px; border: 1px solid rgba(0,0,0,0.2); }
  #playlist-items::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }

  /* --- PLAYLIST ITEMS GLASS CLASS --- */
  .playlist-item {
      display: flex; 
      align-items: center; 
      gap: 15px; 
      padding: 10px;
      border-radius: 8px;
      transition: all 0.2s;
      
      /* Hyper Glass */
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      
      color: white;
      cursor: pointer;

      /* SMOOTHNESS BOOSTER */
      transform: translateZ(0);
      backface-visibility: hidden;
  }
  .playlist-item:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  .playlist-item.locked {
      opacity: 0.5; 
      cursor: not-allowed; 
      filter: grayscale(1);
  }

  @media (min-width: 900px) {
    .main-layout {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 10px; 
      padding: 0 20px; 
      text-align: left;
    }
    .video-wrapper-left { flex: 2; }
    #playlist { flex: 1; margin-top: 0 !important; margin-bottom: 0 !important; max-width: none !important; }
    h3.playlist-header { margin-top: 0 !important; line-height: 1; }
    #playlist-items { 
        max-height: 410px !important; 
        padding-right: 10px;
        /* SMOOTH SCROLL */
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }
  }
</style>
</head>

<body>

<div class="center-logo">
  <img src="https://uploads.onecompiler.io/43ddry4jt/43s3sjvch/Zone%20Vault%20logo.png" loading="lazy" alt="Zone Vault Logo">
</div>

<div class="main-layout">

  <div class="video-wrapper-left">
    
    <div id="poster-container">
      <div id="poster-overlay">Select an Episode to Watch</div>
    </div>

    <div id="player-container">
      <div class="plyr__video-wrapper">
        <video id="videoPlayer" playsinline controls crossorigin="anonymous"></video>
      </div>
    </div>

    <h2 id="main-title">Select Episode</h2>
  </div>

  <div id="playlist" style="width: 100%; max-width: 1000px; margin: 20px auto; text-align: left;">
    <h3 class="playlist-header">Other Episodes</h3>
    
    <div id="playlist-items" style="
        display: flex; 
        flex-direction: column; 
        gap: 10px;
        max-height: 410px; 
        overflow-y: auto; 
        padding-right: 10px;
        /* SMOOTH SCROLL FALLBACK */
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    ">
    </div>
  </div>

</div> 

<script>
// --- 1. CONFIGURATION & DATA ---
const playlistData = [
  { 
    id: "1", 
    title: "DAY 1 - SEVENTEEN [NEW_] WORLD TOUR IN INCHEON", 
    status: "NOT AVAILABLE", // CHANGED: Added this field for the requested text
    image: "https://uploads.onecompiler.io/43ddry4jt/43wkywbqe/Screenshot%202025-09-13%2021-01-14.png" 
  },
  { 
    id: "2", 
    title: "DAY 2 - SEVENTEEN [NEW_] WORLD TOUR IN INCHEON", 
    image: "https://uploads.onecompiler.io/43ddry4jt/43wkywbqe/Screenshot%202025-09-13%2021-01-14.png" 
  }
];

const playlistContainer = document.getElementById('playlist-items');
const posterContainer = document.getElementById('poster-container');
const playerContainer = document.getElementById('player-container');
const mainTitle = document.getElementById('main-title');

// Global variable to store current ep data
window.currentEpData = null;

// --- 2. CORE FUNCTION: PLAY EPISODE ---
// Usage: loadAndPlayEpisode("1", true) -> true means update the URL
function loadAndPlayEpisode(epId, updateUrl = true) {
    // A. Find the episode
    const ep = playlistData.find(item => item.id === epId);
    
    if (!ep) {
        console.warn("Episode ID not found:", epId);
        return;
    }

    // B. Check Date Locking
    const today = new Date();
    if (ep.date) {
        const releaseDate = new Date(ep.date);
        if (releaseDate > today) {
            alert(`This episode is not yet available.\nRelease Date: ${ep.date}`);
            return; 
        }
    }

    // C. Update the Browser Link (Deep Linking)
    if (updateUrl) {
        const newUrl = window.location.pathname + '?v=' + ep.id;
        // pushState changes the URL without reloading the page
        history.pushState({id: ep.id}, '', newUrl);
    }

    // D. Set Data & UI
    window.currentEpData = ep;
    posterContainer.style.display = "none";
    playerContainer.style.display = "block";

    // E. Load Video from Firebase (Path: ourchapter)
    db.ref(`urlnewtour/${ep.id}`).once('value').then(snapshot => {
      const data = snapshot.val();
      if(!data || !data.url) { alert("Video unavailable"); return; }

      if(typeof hls !== 'undefined' && hls){ hls.destroy(); hls = null; }

      // Resume Logic
      const resumePlayback = () => {
          const user = auth.currentUser;
          if (!window.currentEpData || !user) {
             player.play(); 
             return;
          }
          db.ref('watchHistory/' + user.uid + '/' + window.currentEpData.id).once('value').then(snap => {
              const saved = snap.val();
              if (saved && saved.currentTime > 0) {
                  player.currentTime = saved.currentTime;
              }
              player.play();
          });
      };

      if(typeof Hls !== 'undefined' && Hls.isSupported()){
        hls = new Hls();
        hls.loadSource(data.url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => { 
             setTimeout(resumePlayback, 100);
        });
      } else {
        video.src = data.url;
        video.addEventListener('loadedmetadata', resumePlayback, { once: true });
      }

      // Subtitles
      video.querySelectorAll("track").forEach(t => t.remove());
      if(data.subtitles){
        Object.entries(data.subtitles).forEach(([lang,url])=>{
          const track = document.createElement("track");
          track.kind = "subtitles";
          track.label = lang.toUpperCase();
          track.srclang = lang;
          track.src = url;
          if(lang==="en") track.default = true;
          video.appendChild(track);
        });
      }
      
      // Title Update
      if(data.title){
        mainTitle.textContent = data.title;
      } else {
        mainTitle.textContent = ep.title;
      }

    }).catch(err => console.error("Firebase Error:", err));
}

// --- 3. HANDLE BROWSER BACK BUTTON ---
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.id) {
        loadAndPlayEpisode(event.state.id, false);
    } else {
        // Reset to poster if back goes to start
        posterContainer.style.display = "flex";
        playerContainer.style.display = "none";
        player.pause();
    }
});

// --- 4. GENERATE PLAYLIST UI ---
playlistData.forEach(ep => {
  const epDiv = document.createElement('div');
  epDiv.className = 'playlist-item';
   
  const today = new Date();
  let isLocked = false;
  if (ep.date) {
      const releaseDate = new Date(ep.date);
      if (releaseDate > today) isLocked = true;
  }

  if (isLocked) {
      epDiv.classList.add('locked');
  }

  const thumb = document.createElement('img');
  thumb.src = ep.image;
  thumb.style.width = "120px";  
  thumb.style.height = "68px";   
  thumb.style.objectFit = "cover"; 
  thumb.style.borderRadius = "4px";
  
  // SMOOTH LOADING: Lazy load images
  thumb.loading = "lazy";
  thumb.decoding = "async";
  
  const textDiv = document.createElement('div');
  textDiv.style.display = "flex";
  textDiv.style.flexDirection = "column"; 
  
  const title = document.createElement('span');
  title.textContent = ep.title;
  title.style.fontSize = "15px";
  title.style.fontWeight = "500";
  title.style.textShadow = "0 1px 2px rgba(0,0,0,0.8)"; 

  textDiv.appendChild(title);

  if (ep.date) {
      const dateSpan = document.createElement('span');
      dateSpan.textContent = isLocked ? `Available: ${ep.date}` : ep.date;
      dateSpan.style.fontSize = "12px";
      dateSpan.style.color = isLocked ? "#ff5252" : "#ccc";
      dateSpan.style.marginTop = "2px";
      dateSpan.style.textShadow = "0 1px 1px rgba(0,0,0,0.8)";
      textDiv.appendChild(dateSpan);
  }

  // CHANGED: Added logic to show "NOT AVAILABLE" below the title
  if (ep.status) {
      const statusSpan = document.createElement('span');
      statusSpan.textContent = ep.status;
      statusSpan.style.fontSize = "12px";
      statusSpan.style.color = "#ff5252"; // Red color for visibility
      statusSpan.style.fontWeight = "bold";
      statusSpan.style.marginTop = "2px";
      statusSpan.style.textShadow = "0 1px 1px rgba(0,0,0,0.8)";
      textDiv.appendChild(statusSpan);
  }

  epDiv.appendChild(thumb);
  epDiv.appendChild(textDiv);

  // CHANGED: Call the loadAndPlayEpisode function
  epDiv.addEventListener('click', () => {
    loadAndPlayEpisode(ep.id, true);
  });

  playlistContainer.appendChild(epDiv);
});

// --- 5. CHECK URL ON PAGE LOAD ---
window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const videoId = urlParams.get('v'); // Looks for ?v=1
    
    if (videoId) {
        // Delay slightly to ensure Firebase is ready
        setTimeout(() => {
            console.log("Auto-playing from link ID:", videoId);
            loadAndPlayEpisode(videoId, false);
        }, 500);
    }
});
</script>

<a href="videos.html" class="back-btn">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="white">
    <path d="M15 18l-6-6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</a>

<div id="rewind-icon-overlay" class="seek-overlay">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.9998 1.5V6.4428C5.5598 6.9048 2.4418 10.3368 2.4418 14.8828C2.4418 19.8288 6.4418 23.8288 11.3878 23.8288C15.8278 23.8288 19.4678 20.4968 20.0758 16.1988H17.5558C17.0098 18.9888 14.4838 21.3288 11.3878 21.3288C7.8118 21.3288 4.9418 18.4588 4.9418 14.8828C4.9418 11.6688 7.3738 9.0708 10.4998 8.6148V13.4998L17.4998 7.4998L9.9998 1.5Z"/></svg>
</div>
<div id="forward-icon-overlay" class="seek-overlay">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.0002 1.5L6.50016 7.49984L14.0002 13.4998V8.61484C17.1262 9.07084 19.5582 11.6688 19.5582 14.8828C19.5582 18.4588 16.6882 21.3288 13.1122 21.3288C10.0162 21.3288 7.49016 18.9888 6.94416 16.1988H4.42416C5.03216 20.4968 8.67216 23.8288 13.1122 23.8288C18.0582 23.8288 22.0582 19.8288 22.0582 14.8828C22.0582 10.3368 18.9402 6.90484 14.5002 6.44284V1.5Z"/></svg>
</div>
<div id="play-pause-icon-overlay" class="seek-overlay"></div>

<svg id="svg-play" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5.14V19.14L19 12.14L8 5.14Z"/></svg>
<svg id="svg-pause" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19H10V5H6V19ZM14 5V19H18V5H14Z"/></svg>

<script>
const firebaseConfig = {
Â  apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0",
Â  authDomain: "tvnstream-b4497.firebaseapp.com",
Â  databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com",
Â  projectId: "tvnstream-b4497",
Â  storageBucket: "tvnstream-b4497.appspot.com",
Â  messagingSenderId: "308384754214",
Â  appId: "1:308384754214:web:2938e76cd29b288f75d4e7",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(); // Initialized Auth
const db = firebase.database();

const video = document.getElementById("videoPlayer");
let hls;

const player = new Plyr(video, {
Â  captions: { active: true, update: true, language: "en" },
Â  controls: ["play-large","play","progress","current-time","duration","mute","settings","fullscreen"],
Â  settings: ["captions","speed","quality"],
Â  clickToPlay: false,Â 
Â  dblclickFullscreen: false
});

const isMobileOrTablet = /Mobi|Android|iPad|Tablet/i.test(navigator.userAgent);

function enterFullscreen(el) {
Â  if (el.requestFullscreen) el.requestFullscreen();
Â  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
Â  else if (el.msRequestFullscreen) el.msRequestFullscreen();
}

player.on('enterfullscreen', () => {
Â  if (isMobileOrTablet) {
Â  Â  if (screen.orientation && screen.orientation.lock) {
Â  Â  Â  screen.orientation.lock('landscape').catch(err => {});
Â  Â  } else if (window.screen.lockOrientation) {
Â  Â  Â  window.screen.lockOrientation('landscape');
Â  Â  }
Â  }
});

player.on('exitfullscreen', () => {
Â  if (isMobileOrTablet) {
Â  Â  if (screen.orientation && screen.orientation.unlock) {
Â  Â  Â  screen.orientation.unlock();
Â  Â  }
Â  }
});

player.on('ready', () => {
Â  Â  const videoContainer = player.elements.container;
Â  Â  const videoWrapper = videoContainer.querySelector('.plyr__video-wrapper');
Â  Â  if (!videoWrapper) return;

Â  Â  const rewindIcon = document.getElementById('rewind-icon-overlay');
Â  Â  const forwardIcon = document.getElementById('forward-icon-overlay');
Â  Â  const playPauseIcon = document.getElementById('play-pause-icon-overlay');
Â  Â  const playSvg = document.getElementById('svg-play') ? document.getElementById('svg-play').cloneNode(true) : null;
Â  Â  const pauseSvg = document.getElementById('svg-pause') ? document.getElementById('svg-pause').cloneNode(true) : null;
Â  Â Â 
Â  Â  if(playSvg) playSvg.style.display = 'block';
Â  Â  if(pauseSvg) pauseSvg.style.display = 'block';

Â  Â  if (rewindIcon) videoWrapper.appendChild(rewindIcon);
Â  Â  if (forwardIcon) videoWrapper.appendChild(forwardIcon);
Â  Â  if (playPauseIcon) videoWrapper.appendChild(playPauseIcon);

Â  Â  let lastTapTime = 0, tapTimeout = null, iconHideTimeout = null;

Â  Â  function showSeekIcon(type) {
Â  Â  Â  Â  if (iconHideTimeout) clearTimeout(iconHideTimeout);
Â  Â  Â  Â  if(rewindIcon) rewindIcon.classList.remove('visible');
Â  Â  Â  Â  if(forwardIcon) forwardIcon.classList.remove('visible');
Â  Â  Â  Â  if(playPauseIcon) playPauseIcon.classList.remove('visible');

Â  Â  Â  Â  let iconToShow;
Â  Â  Â  Â  if (type === 'rewind') iconToShow = rewindIcon;
Â  Â  Â  Â  else if (type === 'forward') iconToShow = forwardIcon;
Â  Â  Â  Â  else if (type === 'play-pause') {
Â  Â  Â  Â  Â  Â  iconToShow = playPauseIcon;
Â  Â  Â  Â  Â  Â  if(playPauseIcon) {
Â  Â  Â  Â  Â  Â  Â  Â  playPauseIcon.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (player.paused && pauseSvg) playPauseIcon.appendChild(pauseSvg);Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if (!player.paused && playSvg) playPauseIcon.appendChild(playSvg);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if (iconToShow) {
Â  Â  Â  Â  Â  Â  iconToShow.classList.add('visible');
Â  Â  Â  Â  Â  Â  iconHideTimeout = setTimeout(() => { iconToShow.classList.remove('visible'); }, 500);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function handleDoubleTap(event) {
Â  Â  Â  Â  const rect = videoWrapper.getBoundingClientRect();
Â  Â  Â  Â  const tapX = event.clientX - rect.left;
Â  Â  Â  Â  const zoneWidth = rect.width;
Â  Â  Â  Â  if (tapX < zoneWidth * 0.35) { player.rewind(10); showSeekIcon('rewind'); }
Â  Â  Â  Â  else if (tapX > zoneWidth * 0.65) { player.forward(10); showSeekIcon('forward'); }
Â  Â  Â  Â  else { showSeekIcon('play-pause'); player.togglePlay(); }
Â  Â  }

Â  Â  videoWrapper.addEventListener('click', (event) => {
Â  Â  Â  Â  if (event.target.closest('.plyr__controls')) return;
Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  const currentTime = new Date().getTime();
Â  Â  Â  Â  const timeSinceLastTap = currentTime - lastTapTime;
Â  Â  Â  Â  if (tapTimeout) { clearTimeout(tapTimeout); tapTimeout = null; }

Â  Â  Â  Â  if (timeSinceLastTap > 0 && timeSinceLastTap < 300) {
Â  Â  Â  Â  Â  Â  event.preventDefault(); handleDoubleTap(event); lastTapTime = 0;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  tapTimeout = setTimeout(() => { player.toggleControls(); }, 300);
Â  Â  Â  Â  }
Â  Â  Â  Â  lastTapTime = currentTime;
Â  Â  });

Â  Â  videoWrapper.addEventListener('dblclick', (e) => { e.preventDefault(); e.stopPropagation(); });
});

// --- CLOUD SAVING LOGIC (SAVES TO FIREBASE) ---
let lastSaveTime = 0; // Throttle saves

player.on("timeupdate", () => {
Â  Â  const user = auth.currentUser;
Â  Â Â 
Â  Â  // Check every 5 seconds (throttle) to avoid spamming DB
Â  Â  const now = Date.now();
Â  Â  if (user && window.currentEpData && !player.paused && player.currentTime > 5) {
Â  Â  Â  Â  if (now - lastSaveTime > 5000) { // Save every 5s
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- UPGRADE: AUTO DETECT CURRENT PAGE NAME ---
Â  Â  Â  Â  Â  Â  let pageName = window.location.pathname;
Â  Â  Â  Â  Â  Â  if(pageName.startsWith('/')) pageName = pageName.substring(1); // Remove /
Â  Â  Â  Â  Â  Â  if(!pageName) pageName = "videos.html"; // Fallback

Â  Â  Â  Â  Â  Â  const dataToSave = {
Â  Â  Â  Â  Â  Â  Â  Â  id: window.currentEpData.id,
Â  Â  Â  Â  Â  Â  Â  Â  title: window.currentEpData.title,
Â  Â  Â  Â  Â  Â  Â  Â  image: window.currentEpData.image,
Â  Â  Â  Â  Â  Â  Â  Â  currentTime: player.currentTime,
Â  Â  Â  Â  Â  Â  Â  Â  duration: player.duration || 0,
Â  Â  Â  Â  Â  Â  Â  Â  timestamp: now,
Â  Â  Â  Â  Â  Â  Â  Â  page: pageName // SAVES THE PAGE NAME
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Write to Cloud
Â  Â  Â  Â  Â  Â  db.ref('watchHistory/' + user.uid + '/' + window.currentEpData.id).update(dataToSave);
Â  Â  Â  Â  Â  Â  lastSaveTime = now;
Â  Â  Â  Â  }
Â  Â  }
});
</script>

<script>
Â  if ('serviceWorker' in navigator) {
Â  Â  navigator.serviceWorker.register('sw.js').then(reg => {
Â  Â  Â  reg.onupdatefound = () => {
Â  Â  Â  Â  const newSW = reg.installing;
Â  Â  Â  Â  newSW.onstatechange = () => {
Â  Â  Â  Â  Â  if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  window.location.reload();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  };
Â  Â  }).catch(err => {});
Â  }
</script>

<style>
Â  /* Access Denied Modal - Hyper Glass */
Â  .access-denied-modal {
Â  Â  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
Â  Â  background: rgba(0, 0, 0, 0.8);Â 
Â  Â  color: #fff;
Â  Â  font-family: 'Segoe UI', Arial, sans-serif;
Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  z-index: 9999; text-align: center; padding: 20px;
Â  Â  opacity: 0; animation: fadeIn 0.5s forwards; flex-direction: column;
Â  Â  backdrop-filter: blur(15px);
Â  Â  /* SMOOTHNESS BOOSTER */
Â  Â  transform: translateZ(0);
Â  Â  will-change: opacity, backdrop-filter;
Â  }
Â  .access-denied-modal strong { font-size: 24px; margin-bottom: 10px; text-shadow: var(--text-shadow); }
Â  .access-denied-modal button {
Â  Â  margin-top: 15px; padding: 10px 25px;Â 
Â  Â  background: rgba(255,255,255,0.1);
Â  Â  border: 1px solid rgba(255,255,255,0.3);
Â  Â  color: white; border-radius: 50px;
Â  Â  cursor: pointer; font-weight: bold; transition: all 0.3s ease;
Â  Â  backdrop-filter: blur(5px);
Â  }
Â  .access-denied-modal button:hover { background: rgba(255,255,255,0.25); color: white; }
Â  @keyframes fadeIn { to { opacity: 1; } }
</style>

Â <style>
Â  /* Access Denied Modal */
Â  .access-denied-modal {
Â  Â  position: fixed;
Â  Â  top: 0; left: 0; right: 0; bottom: 0;
Â  Â  background: rgba(0, 0, 0, 0.85);
Â  Â  color: #fff;
Â  Â  font-family: 'Segoe UI', Arial, sans-serif;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  z-index: 11000;
Â  Â  text-align: center;
Â  Â  padding: 20px;
Â  Â  opacity: 0;
Â  Â  animation: fadeIn 0.5s forwards;
Â  Â  flex-direction: column;
Â  }

Â  .access-denied-modal strong {
Â  Â  font-size: 24px;
Â  Â  margin-bottom: 10px;
Â  }

Â  .access-denied-modal button {
Â  Â  margin-top: 15px;
Â  Â  padding: 10px 25px;
Â  Â  background: transparent;
Â  Â  color: white;
Â  Â  border: 2px solid white;
Â  Â  border-radius: 50px;
Â  Â  cursor: pointer;
Â  Â  font-weight: bold;
Â  Â  transition: all 0.3s ease;
Â  }

Â  .access-denied-modal button:hover {
Â  Â  background: white;
Â  Â  color: black;
Â  }

Â  @keyframes fadeIn {
Â  Â  to { opacity: 1; }
Â  }
</style>

<script>
Â  const allowedPaths = [
Â  Â  '/index.html',
Â  Â  '/home.html',
Â  Â  '/nanabnb.html',
Â  Â  '/newtour.html',
Â  Â  '/hxwfanconcert.html',
Â  Â  '/svtholiday.html',
Â  Â  '/arenatour.html',
Â  Â  '/svtjapanconcert.html',
Â  Â  '/touragain.html',
Â  Â  '/gallery.html',
Â  Â  '/profile.html',
Â  Â  '/soon.html'
Â  ];

Â  const currentPage = window.location.pathname;

Â  // Check if user already has internalAccess flag
Â  let hasInternalAccess = sessionStorage.getItem('internalAccess') === 'true';

Â  // Check if user came from an allowed page
Â  const referrer = document.referrer;
Â  const refPath = referrer ? new URL(referrer).pathname : null;
Â  const cameFromAllowedPage = refPath && allowedPaths.includes(refPath);

Â  // Grant internalAccess if coming from allowed page
Â  if (cameFromAllowedPage) {
Â  Â  sessionStorage.setItem('internalAccess', 'true');
Â  Â  hasInternalAccess = true;
Â  }

Â  // Allow access if user already has internalAccess or is on index page
Â  const isIndexPage = currentPage.endsWith('index.html') || currentPage === '/';
Â  if (!hasInternalAccess && !isIndexPage) {
Â  Â  showAccessDeniedModal();
Â  }

Â  function showAccessDeniedModal() {
Â  Â  const modal = document.createElement('div');
Â  Â  modal.className = 'access-denied-modal';
Â  Â  modal.innerHTML = `
Â  Â  Â  <strong>ðŸš« Access Denied</strong>
Â  Â  Â  <div>You cannot access this page directly.<br>
Â  Â  Â  Please go through the homepage or allowed sections.</div>
Â  Â  Â  <div id="redirectTimer">Redirecting in 3 seconds...</div>
Â  Â  Â  <button onclick="goBack()">Go Back</button>
Â  Â  `;
Â  Â  document.body.appendChild(modal);

Â  Â  let countdown = 3;
Â  Â  const timer = document.getElementById('redirectTimer');
Â  Â  const interval = setInterval(() => {
Â  Â  Â  countdown--;
Â  Â  Â  timer.textContent = `Redirecting in ${countdown} seconds...`;
Â  Â  Â  if (countdown <= 0) {
Â  Â  Â  Â  clearInterval(interval);
Â  Â  Â  Â  window.location.href = "index.html";
Â  Â  Â  }
Â  Â  }, 1000);
Â  }

Â  function goBack() {
Â  Â  window.history.back();
Â  }
</script>

</body>
</html>
