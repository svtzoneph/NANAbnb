<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IN THE SOOP SEVENTEEN ver. Season2 EP1. READY TO TIME OFF</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>



<!-- Favicon & Manifest -->
  <link rel="icon" href="favicon-new.png" type="image/png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196f3">

  <!-- Apple -->
  <meta name="apple-mobile-web-app-title" content="Zone Vault">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" sizes="192x192" href="favicon-new.png">
  <link rel="apple-touch-icon" sizes="512x512" href="favicon-new.png">
  <link rel="apple-touch-startup-image" href="splash.png">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1B2RJ659GL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1B2RJ659GL');
  </script>

<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: black;
    text-align: center;
    padding: 40px;
    margin: 0;
  }
h2 {
    color: white;
    margin-bottom: 12px;
    font-weight: 700;
    letter-spacing: 0.5px;
    margin-left: 10px; 
    font-size: 30px;
    text-align: center; 
}


@media (max-width: 600px) {
    h2 {
        font-size: 24px;
        margin-left: 5px;
    }
}

@media (max-width: 400px) {
    h2 {
        font-size: 20px;
        margin-left: 2px;
    }
}

  .center-logo { display: flex; justify-content: center; margin-bottom: 20px; }
  .center-logo img { width: 50px; height: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
  @media (max-width: 600px) { .center-logo img { width: 40px; } }

.plyr {
  width: 100%;
  max-width: 800px;
  margin: 0 auto;   
  aspect-ratio: 16/9;
  background: #000;
  border-radius: 0px;
  overflow: hidden;
}
  
  video { width: 100%; }

  .back-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px; height: 50px;
    background: transparent;
    border: 2px solid #fff;
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    text-decoration: none; z-index: 3000;
    transition: all 0.3s ease;
  }
  .back-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }
  .back-btn svg { display: block; }

  :root {
    --plyr-color-main: gray;
    --plyr-control-bg: rgba(255,255,255,0.1);
    --plyr-control-hover-bg: rgba(255,255,255,0.2);
  }

.plyr__captions {
    font-size: 18px;
    font-weight: bold;
    color: white;
    text-shadow: 5px 5px 14px black;
    padding: 4px 8px;
    bottom: 40px !important;
    text-align: center;
}


@media (max-width: 600px) {
    .plyr__captions {
        font-size: 13px;
        bottom: 30px !important;
        padding: 3px 6px;
    }
}

@media (max-width: 400px) {
    .plyr__captions {
        font-size: 11px;
        bottom: 20px !important;
        padding: 2px 4px;
    }
}

@media (max-width: 300px) {
    .plyr__captions {
        font-size: 9px;
        bottom: 15px !important;
        padding: 1px 3px;
    }
}

@media (max-width: 600px) {
  .plyr {
    font-size: 14px; 
  }
  .plyr__controls button {
    padding: 4px !important;
  }
  .plyr__control--play-large {
    width: 50px;
    height: 50px;
  }
}

@media (max-width: 400px) {
  .plyr {
    font-size: 12px;
  }
  .plyr__controls button {
    padding: 2px !important;
  }
  .plyr__control--play-large {
    width: 40px;
    height: 40px;
  }
  
}


  @media (max-width: 600px) { .plyr__captions { font-size: 14px; bottom: 30px !important; } }
  @media (max-width: 400px) { .plyr__captions { font-size: 12px; bottom: 20px !important; } }
  @media (max-width: 300px) { .plyr__captions { font-size: 10px; bottom: 15px !important; } }
  .plyr__captions span { transition: opacity 3s ease-in-out; }

  /* --- NEW STYLES FOR DOUBLE TAP ICONS --- */
  .seek-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background-color: rgba(0, 0, 0, 0.6);
    border-radius: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    z-index: 20; /* Ensure it sits above other video layers */
  }
  .seek-overlay.visible {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  .seek-overlay svg {
    width: 40px;
    height: 40px;
    fill: white;
    display: block;
  }
</style>
</head>

<body>

<div class="center-logo">
  <img src="https://uploads.onecompiler.io/43ddry4jt/43s3sjvch/Zone%20Vault%20logo.png" alt="Zone Vault Logo">
</div>

<h2>EPISODE 1</h2>

<video id="videoPlayer" playsinline controls crossorigin="anonymous"></video>

<a href="main" class="back-btn">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="white">
    <path d="M15 18l-6-6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</a>


<div id="rewind-icon-overlay" class="seek-overlay">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M9.9998 1.5V6.4428C5.5598 6.9048 2.4418 10.3368 2.4418 14.8828C2.4418 19.8288 6.4418 23.8288 11.3878 23.8288C15.8278 23.8288 19.4678 20.4968 20.0758 16.1988H17.5558C17.0098 18.9888 14.4838 21.3288 11.3878 21.3288C7.8118 21.3288 4.9418 18.4588 4.9418 14.8828C4.9418 11.6688 7.3738 9.0708 10.4998 8.6148V13.4998L17.4998 7.4998L9.9998 1.5Z"/>
    
    </svg>
</div>
<div id="forward-icon-overlay" class="seek-overlay">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M14.0002 1.5L6.50016 7.49984L14.0002 13.4998V8.61484C17.1262 9.07084 19.5582 11.6688 19.5582 14.8828C19.5582 18.4588 16.6882 21.3288 13.1122 21.3288C10.0162 21.3288 7.49016 18.9888 6.94416 16.1988H4.42416C5.03216 20.4968 8.67216 23.8288 13.1122 23.8288C18.0582 23.8288 22.0582 19.8288 22.0582 14.8828C22.0582 10.3368 18.9402 6.90484 14.5002 6.44284V1.5Z"/>
    </svg>
</div>
<div id="play-pause-icon-overlay" class="seek-overlay"></div>

<svg id="svg-play" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
  <path d="M8 5.14V19.14L19 12.14L8 5.14Z"/>
</svg>
<svg id="svg-pause" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
  <path d="M6 19H10V5H6V19ZM14 5V19H18V5H14Z"/>
</svg>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0",
  authDomain: "tvnstream-b4497.firebaseapp.com",
  databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com",
  projectId: "tvnstream-b4497",
  storageBucket: "tvnstream-b4497.appspot.com",
  messagingSenderId: "308384754214",
  appId: "1:308384754214:web:2938e76cd29b288f75d4e7",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const video = document.getElementById("videoPlayer");
let hls;
let positions = JSON.parse(localStorage.getItem("plyr-positions") || "{}");

const player = new Plyr(video, {
  captions: { active: true, update: true, language: "en" },
  controls: ["play-large","play","progress","current-time","duration","mute","settings","fullscreen"],
  settings: ["captions","speed","quality"],
  clickToPlay: false, 
  dblclickFullscreen: false
});

// --- AUTO LANDSCAPE FULLSCREEN ON MOBILE/TABLET ---
const isMobileOrTablet = /Mobi|Android|iPad|Tablet/i.test(navigator.userAgent);

function enterFullscreen(el) {
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  else if (el.msRequestFullscreen) el.msRequestFullscreen();
}

// Hook into Plyr fullscreen events
player.on('enterfullscreen', () => {
  if (isMobileOrTablet) {
    // Lock orientation to landscape
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock('landscape').catch(err => {
        console.log("Orientation lock failed:", err);
      });
    } else if (window.screen.lockOrientation) {
      window.screen.lockOrientation('landscape');
    }
  }
});

player.on('exitfullscreen', () => {
  if (isMobileOrTablet) {
    // Unlock orientation when exiting fullscreen
    if (screen.orientation && screen.orientation.unlock) {
      screen.orientation.unlock();
    }
  }
});


// --- DOUBLE TAP / CLICK
player.on('ready', () => {
    const videoContainer = player.elements.container;
    const videoWrapper = videoContainer.querySelector('.plyr__video-wrapper');
    if (!videoWrapper) { console.warn("Plyr video wrapper not found yet."); return; }

    const rewindIcon = document.getElementById('rewind-icon-overlay');
    const forwardIcon = document.getElementById('forward-icon-overlay');
    const playPauseIcon = document.getElementById('play-pause-icon-overlay');
    const playSvg = document.getElementById('svg-play') ? document.getElementById('svg-play').cloneNode(true) : null;
    const pauseSvg = document.getElementById('svg-pause') ? document.getElementById('svg-pause').cloneNode(true) : null;
    
    if(playSvg) playSvg.style.display = 'block';
    if(pauseSvg) pauseSvg.style.display = 'block';

    if (rewindIcon) videoWrapper.appendChild(rewindIcon);
    if (forwardIcon) videoWrapper.appendChild(forwardIcon);
    if (playPauseIcon) videoWrapper.appendChild(playPauseIcon);

    let lastTapTime = 0, tapTimeout = null, iconHideTimeout = null;

    function showSeekIcon(type) {
        if (iconHideTimeout) clearTimeout(iconHideTimeout);
        if(rewindIcon) rewindIcon.classList.remove('visible');
        if(forwardIcon) forwardIcon.classList.remove('visible');
        if(playPauseIcon) playPauseIcon.classList.remove('visible');

        let iconToShow;
        if (type === 'rewind') iconToShow = rewindIcon;
        else if (type === 'forward') iconToShow = forwardIcon;
        else if (type === 'play-pause') {
            iconToShow = playPauseIcon;
            if(playPauseIcon) {
                playPauseIcon.innerHTML = '';
                if (player.paused && pauseSvg) playPauseIcon.appendChild(pauseSvg); 
                else if (!player.paused && playSvg) playPauseIcon.appendChild(playSvg);
            }
        }
        if (iconToShow) {
            iconToShow.classList.add('visible');
            iconHideTimeout = setTimeout(() => { iconToShow.classList.remove('visible'); }, 500);
        }
    }

    function handleDoubleTap(event) {
        const rect = videoWrapper.getBoundingClientRect();
        const tapX = event.clientX - rect.left;
        const zoneWidth = rect.width;
        if (tapX < zoneWidth * 0.35) { player.rewind(10); showSeekIcon('rewind'); }
        else if (tapX > zoneWidth * 0.65) { player.forward(10); showSeekIcon('forward'); }
        else { showSeekIcon('play-pause'); player.togglePlay(); }
    }

    videoWrapper.addEventListener('click', (event) => {
        if (event.target.closest('.plyr__controls')) return;
        event.stopPropagation();
        const currentTime = new Date().getTime();
        const timeSinceLastTap = currentTime - lastTapTime;
        if (tapTimeout) { clearTimeout(tapTimeout); tapTimeout = null; }

        if (timeSinceLastTap > 0 && timeSinceLastTap < 300) {
            event.preventDefault(); handleDoubleTap(event); lastTapTime = 0;
        } else {
            event.preventDefault();
            tapTimeout = setTimeout(() => { player.toggleControls(); }, 300);
        }
        lastTapTime = currentTime;
    });

    videoWrapper.addEventListener('dblclick', (e) => { e.preventDefault(); e.stopPropagation(); });
});

// --- LOAD VIDEO FROM FIREBASE ---
db.ref("inthesoop2/1").once("value").then(snapshot => {
  const data = snapshot.val();
  console.log("Firebase Data:", data);

  if (!data || !data.url) { alert("Video unavailable (No URL found in Firebase)"); return; }


  if(data.title) {
    const h2 = document.querySelector("h2");
    h2.textContent = data.title; 
  }

  if(hls) { hls.destroy(); hls = null; }

  if (Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(data.url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => { player.play(); });
  } else {
    video.src = data.url;
  }


  if (data.subtitles) {
    Object.entries(data.subtitles).forEach(([lang, url]) => {
      const track = document.createElement("track");
      track.kind = "subtitles";
      track.label = lang.toUpperCase();
      track.srclang = lang;
      track.src = url;
      if (lang === "en") track.default = true;
      video.appendChild(track);
    });
  }


  player.once("canplay", () => {
    player.currentTime = positions["ep1"] || 0;
    player.play();
    const textTracks = video.textTracks;
    for (let i = 0; i < textTracks.length; i++) {
      textTracks[i].mode = textTracks[i].language === "en" ? "showing" : "disabled";
    }
  });
}).catch((error) => { console.error("Firebase Error:", error); alert("Error loading video data: " + error.message); });


player.on("timeupdate", () => {
  positions["ep1"] = player.currentTime;
  localStorage.setItem("plyr-positions", JSON.stringify(positions));
});
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => {
      // âœ… Detect updates
      reg.onupdatefound = () => {
        const newSW = reg.installing;
        newSW.onstatechange = () => {
          if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
            // âœ… New version is ready â†’ force reload
            window.location.reload();
          }
        };
      };
    }).catch(err => {
      console.error('Service Worker registration failed:', err);
    });
  }
</script>

<style>
  /* Access Denied Modal */
  .access-denied-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    font-family: 'Segoe UI', Arial, sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    text-align: center;
    padding: 20px;
    opacity: 0;
    animation: fadeIn 0.5s forwards;
    flex-direction: column;
  }

  .access-denied-modal strong {
    font-size: 24px;
    margin-bottom: 10px;
  }

  .access-denied-modal button {
    margin-top: 15px;
    padding: 10px 25px;
    background: transparent;
    color: white;
    border: 2px solid white;
    border-radius: 50px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .access-denied-modal button:hover {
    background: white;
    color: black;
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }
</style>

<script>
  const allowedPaths = [
    '/index.html',
    '/home.html',
    '/nanabnb.html',
    '/newtour.html',
    '/hxwfanconcert.html',
    '/svtholiday.html',
    '/arenatour.html',
    '/svtjapanconcert.html',
    '/touragain.html',
    '/gallery.html',
    '/profile.html',
    '/soon.html'
  ];

  const currentPage = window.location.pathname;

  // Check if user already has internalAccess flag
  let hasInternalAccess = sessionStorage.getItem('internalAccess') === 'true';

  // Check if user came from an allowed page
  const referrer = document.referrer;
  const refPath = referrer ? new URL(referrer).pathname : null;
  const cameFromAllowedPage = refPath && allowedPaths.includes(refPath);

  // Grant internalAccess if coming from allowed page
  if (cameFromAllowedPage) {
    sessionStorage.setItem('internalAccess', 'true');
    hasInternalAccess = true;
  }

  // Allow access if user already has internalAccess or is on index page
  const isIndexPage = currentPage.endsWith('index.html') || currentPage === '/';
  if (!hasInternalAccess && !isIndexPage) {
    showAccessDeniedModal();
  }

  function showAccessDeniedModal() {
    const modal = document.createElement('div');
    modal.className = 'access-denied-modal';
    modal.innerHTML = `
      <strong>ðŸš« Access Denied</strong>
      <div>You cannot access this page directly.<br>
      Please go through the homepage or allowed sections.</div>
      <div id="redirectTimer">Redirecting in 3 seconds...</div>
      <button onclick="goBack()">Go Back</button>
    `;
    document.body.appendChild(modal);

    let countdown = 3;
    const timer = document.getElementById('redirectTimer');
    const interval = setInterval(() => {
      countdown--;
      timer.textContent = `Redirecting in ${countdown} seconds...`;
      if (countdown <= 0) {
        clearInterval(interval);
        window.location.href = "index.html";
      }
    }, 1000);
  }

  function goBack() {
    window.history.back();
  }
</script>

</body>
</html>
