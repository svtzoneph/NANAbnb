<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zone Vault - Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon-new.png" type="image/png">
  <meta name="theme-color" content="#0a0a0a">

  <style>
    :root {
      --primary: #ffffff;
      --secondary: #a1a1aa;
      --accent: #3b82f6;
      --bg-dark: #050505;
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-bg: rgba(20, 20, 20, 0.6);
      --input-bg: rgba(255, 255, 255, 0.03);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-dark);
      color: var(--primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    /* === BACKGROUND EFFECTS === */
    .bg-gradient {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
      background: 
        radial-gradient(circle at 15% 50%, rgba(56, 189, 248, 0.05), transparent 25%), 
        radial-gradient(circle at 85% 30%, rgba(168, 85, 247, 0.05), transparent 25%);
    }
    .noise-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none; z-index: -1;
    }

    /* === BACK BUTTON === */
    #back-btn {
      position: fixed; top: 20px; left: 20px;
      background: transparent; border: 1px solid var(--glass-border);
      color: var(--secondary);
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s ease; z-index: 10;
    }
    #back-btn:hover { color: white; border-color: white; background: rgba(255,255,255,0.05); }

    /* === MAIN CARD === */
    .container {
      background: rgba(15, 15, 15, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      padding: 40px 30px;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 400px;
      position: relative;
      animation: popIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      margin: 20px;
    }

    @keyframes popIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    h2 { 
      font-family: 'Poppins', sans-serif; 
      text-align: center; margin-bottom: 8px; font-size: 1.75rem; color: #fff; 
    }
    .subtitle {
      text-align: center; color: var(--secondary); font-size: 0.9rem; margin-bottom: 30px;
    }

    /* === INPUTS === */
    .input-icon-group {
      position: relative; margin-bottom: 16px;
    }
    .input-icon-group i {
      position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
      color: var(--secondary); font-size: 14px; pointer-events: none; transition: 0.3s;
    }
    input {
      width: 100%; padding: 14px 16px 14px 44px;
      background: var(--input-bg);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      color: #fff; font-size: 14px; outline: none; transition: 0.3s;
      font-family: 'Inter', sans-serif;
    }
    input::placeholder { color: #555; }
    input:focus {
      border-color: rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.05);
    }
    input:focus + i, .input-icon-group:focus-within i { color: #fff; }

    /* === BUTTONS === */
    .button-stack { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
    
    button {
      width: 100%; padding: 14px; border-radius: 8px;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; border: none; font-family: 'Inter', sans-serif;
    }

    .login-btn {
      background: #fff; color: #000;
    }
    .login-btn:hover { background: #e5e5e5; transform: translateY(-1px); }

    .google-btn {
      background: transparent; color: #fff;
      border: 1px solid var(--glass-border);
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .google-btn:hover { background: rgba(255,255,255,0.05); border-color: #fff; }
    .google-btn img { height: 18px; }

    /* === UTILS === */
    .register-link {
      font-size: 13px; color: var(--secondary); text-align: center; margin-top: 20px;
    }
    .register-link a { color: #fff; text-decoration: none; font-weight: 500; }
    .register-link a:hover { text-decoration: underline; }

    .hidden { display: none !important; }

    /* === STATUS STATES === */
    .status-icon { font-size: 3rem; margin-bottom: 15px; display: block; text-align: center; }
    
    #verify-section, #waiting, #approved, #form-section { text-align: center; }
    #verify-section h3, #waiting h3, #approved h3 { font-size: 1.2rem; margin-bottom: 10px; }
    #verify-section p, #waiting p { color: var(--secondary); font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px; }

    @media (max-width: 480px) {
      .container { padding: 30px 20px; border: none; background: transparent; box-shadow: none; }
      h2 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

<div class="bg-gradient"></div>
<div class="noise-overlay"></div>

<button id="back-btn" onclick="window.history.back()">
  <i class="fas fa-arrow-left"></i>
</button>

<div class="container">
  
  <div id="auth-section">
    <h2>Zone Vault</h2>
    <p class="subtitle">Welcome back. Please login.</p>
    
    <div class="input-icon-group">
      <i class="fas fa-envelope"></i>
      <input type="email" id="email" placeholder="Email address" required>
    </div>
    <div class="input-icon-group">
      <i class="fas fa-lock"></i>
      <input type="password" id="password" placeholder="Password" required>
    </div>

    <div class="button-stack">
      <button class="login-btn" onclick="login()">Sign In</button>
      <button class="google-btn" onclick="googleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        Continue with Google
      </button>
    </div>

    <p class="register-link">Don't have an account? <a href="register.html">Sign up</a></p>
  </div>

  <div id="verify-section" class="hidden">
    <span class="status-icon">üìß</span>
    <h3>Verify Email</h3>
    <p>We've sent a verification link to your email address. Please check your inbox.</p>
    <button class="login-btn" onclick="reloadAndCheck()">I've Verified My Email</button>
  </div>

  <div id="form-section" class="hidden">
    <h2>Request Access</h2>
    <p class="subtitle">Complete your profile to join.</p>
    
    <div class="input-icon-group">
      <i class="fab fa-telegram-plane"></i>
      <input type="text" id="name" placeholder="Telegram Username" required>
    </div>
    <div class="input-icon-group">
      <i class="fas fa-key"></i>
      <input type="text" id="reason" placeholder="Access Code" required>
    </div>
    
    <div class="button-stack">
      <button class="login-btn" onclick="submitRequest()">Submit Request</button>
    </div>
  </div>

  <div id="waiting" class="hidden">
    <span class="status-icon">‚è≥</span>
    <h3>Pending Approval</h3>
    <p>Your request is being reviewed by an admin. <br>Message <strong>Hoskwi_17</strong> on Telegram for faster approval.</p>
    <button class="google-btn" onclick="location.reload()">Check Status</button>
  </div>

  <div id="approved" class="hidden">
    <span class="status-icon">‚úÖ</span>
    <h3>Access Granted</h3>
    <p>Redirecting to Zone Vault...</p>
  </div>
</div>

<script type="module">
  // 1. Imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged,
    reload, signInWithPopup, GoogleAuthProvider, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getDatabase, ref, onValue, get, set, update, push, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import {
    getMessaging, getToken, onMessage
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

  // 2. Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0",
    authDomain: "tvnstream-b4497.firebaseapp.com",
    databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com",
    projectId: "tvnstream-b4497",
    storageBucket: "tvnstream-b4497.appspot.com",
    messagingSenderId: "308384754214",
    appId: "1:308384754214:web:2938e76cd29b288f75d4e7",
    measurementId: "G-VFNH70R4D9"
  };

  // 3. Initialize
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const provider = new GoogleAuthProvider();
  const messaging = getMessaging(app);

  let currentUid = null;
  let localUserId = localStorage.getItem("userId");
  if (!localUserId) {
    localUserId = "user_" + Math.random().toString(36).substring(2, 10);
    localStorage.setItem("userId", localUserId);
  }

  // 4. UI Functions
  function show(id) {
    document.querySelectorAll(".container > div").forEach(div => div.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
  }

  // 5. CORE LOGIC
  window.login = function() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    if (!email || !password) return alert("Please enter email and password.");
    
    signInWithEmailAndPassword(auth, email, password)
      .then(userCred => {
        reload(userCred.user).then(() => {
             if(userCred.user.emailVerified) {
                 checkJoinRequest(userCred.user);
             } else {
                 show("verify-section");
             }
        });
      })
      .catch(e => alert("Login error: " + e.message));
  };

  window.googleLogin = async function() {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      currentUid = user.uid;
      checkJoinRequest(user);
    } catch (e) {
      alert("Google login error: " + e.message);
    }
  };

  window.reloadAndCheck = function() {
    const user = auth.currentUser;
    if (user) {
      reload(user).then(() => {
        if (user.emailVerified) checkJoinRequest(user);
        else alert("‚ùå Your email is still not verified.");
      });
    }
  };

  window.submitRequest = function() {
    const name = document.getElementById("name").value;
    const reason = document.getElementById("reason").value;
    const user = auth.currentUser;
    
    if (!name || !reason) return alert("Please fill out all fields.");
    
    set(ref(db, 'joinRequests/' + currentUid), {
      name, 
      reason, 
      email: user.email,
      provider: user.providerData[0]?.providerId || "password",
      status: "pending"
    }).then(() => show("waiting"));
  };

  // 6. Helper Functions
  function checkJoinRequest(user) {
    currentUid = user.uid;
    const reqRef = ref(db, 'joinRequests/' + currentUid);
    
    onValue(reqRef, snapshot => {
      const data = snapshot.val();
      if (!data) {
        show("form-section");
      } else if (data.status === "approved") {
        sessionStorage.setItem("internalAccess", "true");
        sessionStorage.setItem("fromIndex", "true");
        show("approved");
        setTimeout(() => window.location.href = "home", 1500);
      } else if (data.status === "pending") {
        show("waiting");
      } else {
        alert("‚ùå Your request was denied.");
        signOut(auth).then(() => show("auth-section"));
      }
    });
  }

  const deviceInfo = navigator.userAgent;

  function logActivity(action, pageOrDetails) {
    try {
        const uid = currentUid || localUserId;
        
        // Activity Log
        const rec = {
          email: auth.currentUser?.email || 'anonymous',
          uid: uid,
          action: action || 'page_view',
          page: typeof pageOrDetails === 'string' && pageOrDetails.startsWith('/') ? pageOrDetails : window.location.pathname,
          timestamp: Date.now(),
          userAgent: navigator.userAgent || '',
          platform: navigator.platform || '',
          screen: `${screen.width}x${screen.height}`,
          referrer: document.referrer || ''
        };
        const node = ref(db, `userActivities/${uid}/${Date.now()}_${Math.random().toString(36).slice(2,8)}`);
        set(node, rec).catch(e=> console.error('logActivity Old err', e));

        // Session Log
        const sessionRef = ref(db, "userSessions/" + uid);
        update(sessionRef, {
          lastAction: action,
          lastDetails: pageOrDetails || "",
          lastActive: new Date().toLocaleString(),
          device: deviceInfo,
          currentPage: window.location.pathname
        });
        const activityRef = push(ref(db, "userSessions/" + uid + "/activityLog"));
        set(activityRef, {
          action, details: pageOrDetails || "", timestamp: serverTimestamp(), page: window.location.pathname
        });

    } catch(e){ console.error("Logging Error:", e); }
  }

  function trackUserSession(uid) {
    update(ref(db, "userSessions/" + uid), {
      loginTime: new Date().toLocaleString(),
      device: deviceInfo,
      page: window.location.pathname
    });
  }

  // 7. Event Listeners
  window.addEventListener("load", () => logActivity("Page Visit", document.title));
  document.addEventListener("click", e => logActivity("Click", `Clicked ${e.target.tagName}`)); 
  window.addEventListener("beforeunload", () => logActivity("Left Page", document.title));

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUid = user.uid;
      reload(user).then(() => {
        if (user.emailVerified || user.providerData.some(p => p.providerId === "google.com")) {
          checkJoinRequest(user);
          trackUserSession(user.uid);
          subscribeToNotifications(user.uid);
        } else {
          show("verify-section");
        }
      });
    } else {
      show("auth-section");
    }
  });

  // 8. Notifications
  async function subscribeToNotifications(userId) {
    try {
      if(Notification.permission === "default") {
          const permission = await Notification.requestPermission();
          if (permission !== "granted") return;
      }
      const token = await getToken(messaging, {
        vapidKey: "BKIRidsAoqVkU5UwhUq17FGUMLriCTBs9407EC6BNuZ6zgiyaypFVGD7UNGN5JT1SB7iry0t9_jmqJwe94n_T6g"
      });
      if (token) await set(ref(db, "users/" + userId + "/fcmToken"), token);
    } catch (err) {
      console.error("Notification error:", err);
    }
  }

  onMessage(messaging, payload => {
    new Notification(payload.notification?.title || "New Notification", {
      body: payload.notification?.body || "",
      icon: payload.notification?.image || "/favicon-new.png"
    });
  });

</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg => {
    reg.onupdatefound = () => {
      const newSW = reg.installing;
      newSW.onstatechange = () => {
        if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
          window.location.reload();
        }
      };
    };
  }).catch(err => console.error('Service Worker registration failed:', err));
}
</script>

</body>
</html>
