<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zone Vault - Register</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon-new.png" type="image/png">
  <meta name="theme-color" content="#0a0a0a">

  <style>
    :root {
      --primary: #ffffff;
      --secondary: #a1a1aa;
      --bg-dark: #050505;
      --glass-border: rgba(255, 255, 255, 0.08);
      --input-bg: rgba(255, 255, 255, 0.03);
      
      /* Strength Colors */
      --color-weak: #ef4444;   /* Red */
      --color-medium: #eab308; /* Yellow/Gold */
      --color-strong: #22c55e; /* Green */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-dark);
      color: var(--primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    /* === BACKGROUND EFFECTS === */
    .bg-gradient {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
      background: 
        radial-gradient(circle at 85% 20%, rgba(56, 189, 248, 0.05), transparent 25%), 
        radial-gradient(circle at 15% 80%, rgba(168, 85, 247, 0.05), transparent 25%);
    }
    .noise-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none; z-index: -1;
    }

    /* === BACK BUTTON === */
    #back-btn {
      position: fixed; top: 20px; left: 20px;
      background: transparent; border: 1px solid var(--glass-border);
      color: var(--secondary);
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s ease; z-index: 10;
    }
    #back-btn:hover { color: white; border-color: white; background: rgba(255,255,255,0.05); }

    /* === MAIN CARD === */
    .container {
      background: rgba(15, 15, 15, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      padding: 40px 30px;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 400px;
      position: relative;
      animation: popIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      margin: 20px;
    }

    @keyframes popIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    h2 { 
      font-family: 'Poppins', sans-serif; 
      text-align: center; margin-bottom: 8px; font-size: 1.75rem; color: #fff; 
    }
    .subtitle {
      text-align: center; color: var(--secondary); font-size: 0.9rem; margin-bottom: 30px;
    }

    /* === INPUTS === */
    .input-icon-group {
      position: relative; margin-bottom: 16px;
    }
    
    /* Left side icon (generic) */
    .input-icon-group .input-icon {
      position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
      color: var(--secondary); font-size: 14px; pointer-events: none; transition: 0.3s;
    }
    
    /* Right side icon (Eye toggle) */
    .input-icon-group .toggle-password {
      position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
      color: var(--secondary); font-size: 14px; cursor: pointer; transition: 0.3s;
      pointer-events: auto; /* Allow clicking */
      z-index: 5;
    }
    .input-icon-group .toggle-password:hover { color: #fff; }

    input {
      width: 100%; padding: 14px 40px 14px 44px; /* Added right padding for eye icon */
      background: var(--input-bg);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      color: #fff; font-size: 14px; outline: none; transition: 0.3s;
      font-family: 'Inter', sans-serif;
    }
    input::placeholder { color: #555; }
    input:focus {
      border-color: rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.05);
    }
    input:focus + .input-icon, .input-icon-group:focus-within .input-icon { color: #fff; }

    /* === PASSWORD STRENGTH METER === */
    .strength-meter-container {
      margin-top: -8px;
      margin-bottom: 20px;
      padding: 0 4px;
      display: none; /* Hidden by default until typing starts */
    }
    .strength-meter-container.active { display: block; }
    
    .strength-bars {
      display: flex; gap: 4px; margin-bottom: 4px;
    }
    .bar-segment {
      height: 4px; flex: 1; border-radius: 2px;
      background: rgba(255, 255, 255, 0.1);
      transition: background-color 0.3s ease;
    }
    .strength-text {
      text-align: right; font-size: 11px; font-weight: 500; color: var(--secondary);
    }

    /* === BUTTONS === */
    .button-stack { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
    
    button {
      width: 100%; padding: 14px; border-radius: 8px;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; border: none; font-family: 'Inter', sans-serif;
    }

    .action-btn {
      background: #fff; color: #000;
    }
    .action-btn:hover { background: #e5e5e5; transform: translateY(-1px); }

    .google-btn {
      background: transparent; color: #fff;
      border: 1px solid var(--glass-border);
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .google-btn:hover { background: rgba(255,255,255,0.05); border-color: #fff; }
    .google-btn img { height: 18px; }

    /* === UTILS === */
    .switch-link {
      font-size: 13px; color: var(--secondary); text-align: center; margin-top: 20px;
    }
    .switch-link a { color: #fff; text-decoration: none; font-weight: 500; }
    .switch-link a:hover { text-decoration: underline; }

    .hidden { display: none !important; }
    
    /* === STATUS ICONS === */
    .status-icon { font-size: 3rem; margin-bottom: 15px; display: block; text-align: center; }
    
    #verify-section, #waiting, #approved, #form-section { text-align: center; }
    #verify-section h3, #waiting h3, #approved h3 { font-size: 1.2rem; margin-bottom: 10px; color: #fff; }
    #verify-section p, #waiting p { color: var(--secondary); font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px; }

    @media (max-width: 480px) {
      .container { padding: 30px 20px; border: none; background: transparent; box-shadow: none; }
      h2 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

<div class="bg-gradient"></div>
<div class="noise-overlay"></div>

<button id="back-btn" onclick="window.history.back()">
  <i class="fas fa-arrow-left"></i>
</button>

<div class="container">
  
  <div id="auth-section">
    <h2>Join Zone Vault</h2>
    <p class="subtitle">Create your secure account.</p>
    
    <div class="input-icon-group">
      <i class="fas fa-envelope input-icon"></i>
      <input type="email" id="email" placeholder="Email address" required>
    </div>

    <div class="input-icon-group">
      <i class="fas fa-lock input-icon"></i>
      <input type="password" id="password" placeholder="Create Password" required>
      <i class="fas fa-eye toggle-password" id="togglePassword"></i>
    </div>

    <div class="strength-meter-container" id="strengthMeter">
      <div class="strength-bars">
        <div class="bar-segment" id="bar1"></div>
        <div class="bar-segment" id="bar2"></div>
        <div class="bar-segment" id="bar3"></div>
      </div>
      <div class="strength-text" id="strengthText">Weak</div>
    </div>

    <div class="button-stack">
      <button class="action-btn" onclick="register()">Create Account</button>
      <button class="google-btn" onclick="googleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        Sign up with Google
      </button>
    </div>

    <p class="switch-link">Already have an account? <a href="login.html">Log In</a></p>
  </div>

  <div id="verify-section" class="hidden">
    <span class="status-icon">üìß</span>
    <h3>Verify Your Email</h3>
    <p>We've sent a verification link to your email address. Please check your inbox.</p>
    <button class="action-btn" onclick="reloadAndCheck()">I've Verified My Email</button>
  </div>

  <div id="form-section" class="hidden">
    <h2>Request Access</h2>
    <p class="subtitle">Complete your profile to join.</p>
    
    <div class="input-icon-group">
      <i class="fab fa-telegram-plane input-icon"></i>
      <input type="text" id="name" placeholder="Telegram Username" required>
    </div>
    <div class="input-icon-group">
      <i class="fas fa-key input-icon"></i>
      <input type="text" id="reason" placeholder="Access Code" required>
    </div>
    
    <div class="button-stack">
      <button class="action-btn" onclick="submitRequest()">Submit Request</button>
    </div>
  </div>

  <div id="waiting" class="hidden">
    <span class="status-icon">‚è≥</span>
    <h3>Pending Approval</h3>
    <p>Your request is being reviewed by an admin. <br>Message <strong>Hoskwi_17</strong> on Telegram for faster approval.</p>
    <button class="google-btn" onclick="location.reload()">Check Status</button>
  </div>

  <div id="approved" class="hidden">
    <span class="status-icon">‚úÖ</span>
    <h3>Welcome!</h3>
    <p>Redirecting to Zone Vault...</p>
  </div>
</div>

<script>
  // === 1. TOGGLE PASSWORD VISIBILITY ===
  const togglePassword = document.getElementById('togglePassword');
  const passwordInput = document.getElementById('password');

  togglePassword.addEventListener('click', function () {
    // Toggle the type attribute
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    
    // Toggle the eye icon
    this.classList.toggle('fa-eye');
    this.classList.toggle('fa-eye-slash');
  });

  // === 2. PASSWORD STRENGTH CHECKER ===
  const strengthMeter = document.getElementById('strengthMeter');
  const strengthText = document.getElementById('strengthText');
  const bar1 = document.getElementById('bar1');
  const bar2 = document.getElementById('bar2');
  const bar3 = document.getElementById('bar3');

  passwordInput.addEventListener('input', function() {
    const val = passwordInput.value;
    
    // Show meter if typing
    if (val.length > 0) {
      strengthMeter.classList.add('active');
    } else {
      strengthMeter.classList.remove('active');
      resetBars();
      return;
    }

    // Logic: 
    // 0 = Weak (Too short)
    // 1 = Medium (Length > 6)
    // 2 = Strong (Length > 8 + Numbers/Symbols)
    
    let score = 0;
    if (val.length > 6) score++;
    if (val.length >= 8 && /[0-9!@#$%^&*]/.test(val)) score++;

    updateMeter(score);
  });

  function resetBars() {
    bar1.style.background = 'rgba(255, 255, 255, 0.1)';
    bar2.style.background = 'rgba(255, 255, 255, 0.1)';
    bar3.style.background = 'rgba(255, 255, 255, 0.1)';
    strengthText.textContent = '';
  }

  function updateMeter(score) {
    resetBars();
    
    if (score === 0) {
      // Weak
      bar1.style.background = 'var(--color-weak)';
      strengthText.textContent = 'Weak';
      strengthText.style.color = 'var(--color-weak)';
    } else if (score === 1) {
      // Medium
      bar1.style.background = 'var(--color-medium)';
      bar2.style.background = 'var(--color-medium)';
      strengthText.textContent = 'Medium';
      strengthText.style.color = 'var(--color-medium)';
    } else if (score >= 2) {
      // Strong
      bar1.style.background = 'var(--color-strong)';
      bar2.style.background = 'var(--color-strong)';
      bar3.style.background = 'var(--color-strong)';
      strengthText.textContent = 'Strong';
      strengthText.style.color = 'var(--color-strong)';
    }
  }
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  sendEmailVerification,
  signInWithPopup,
  GoogleAuthProvider,
  onAuthStateChanged,
  reload,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getDatabase,
  ref,
  onValue,
  set,
  get,
  update,
  push,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// ---------- FIREBASE CONFIG ----------
const firebaseConfig = {
  apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0",
  authDomain: "tvnstream-b4497.firebaseapp.com",
  databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com",
  projectId: "tvnstream-b4497",
  storageBucket: "tvnstream-b4497.appspot.com",
  messagingSenderId: "308384754214",
  appId: "1:308384754214:web:2938e76cd29b288f75d4e7"
};

// ---------- INITIALIZE ----------
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();
let currentUid = null;

// ---------- UTILITIES ----------
function show(id) {
  document.querySelectorAll(".container > div").forEach(div =>
    div.classList.add("hidden")
  );
  document.getElementById(id).classList.remove("hidden");
}

function generateAccessID() {
  return (
    Math.random().toString(36).substring(2, 10) +
    Math.random().toString(36).substring(2, 10) +
    Math.random().toString(36).substring(2, 10)
  );
}

// ---------- LOGGING FUNCTIONS (Combined) ----------
function logActivity(action, page) {
  try {
    const user = auth.currentUser;
    const uid = user?.uid || sessionStorage.getItem("currentUid") || "anonymous";
    const rec = {
      email: user?.email || "anonymous",
      uid,
      action: action || "page_view",
      page: page || window.location.pathname,
      timestamp: Date.now(),
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      screen: `${screen.width}x${screen.height}`,
      referrer: document.referrer || ""
    };

    const node = ref(db, `userActivities/${uid}/${Date.now()}_${Math.random().toString(36).slice(2,8)}`);
    set(node, rec).catch(e => console.error("logActivity err", e));
  } catch (e) {
    console.error(e);
  }
}

// ---------- SESSION HANDLING ----------
async function recordSession(user, accessID, page = "home.html") {
  const sessionRef = ref(db, "currentSessions/" + user.uid);
  await set(sessionRef, {
    email: user.email,
    accessID,
    lastActive: Date.now(),
    page
  });
}

async function recordLoginHistory(user) {
  const histRef = ref(db, "loginHistory/" + user.uid);
  await push(histRef, {
    email: user.email,
    provider: user.providerData[0]?.providerId || "password",
    timestamp: Date.now()
  });
}

// ---------- HANDLE APPROVED USER ----------
async function handleApprovedUser(reqRef, data) {
  const accessID = generateAccessID();
  await update(reqRef, { accessID });

  sessionStorage.setItem("internalAccess", "true");
  sessionStorage.setItem("fromIndex", "true");
  sessionStorage.setItem("accessID", accessID);

  await recordSession(auth.currentUser, accessID);
  await recordLoginHistory(auth.currentUser);

  show("approved");
  setTimeout(() => {
    window.location.href = `home.html?access=${accessID}`;
  }, 1500);
}

// ---------- REGISTER NEW USER ----------
window.register = function() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  if (!email || !password) return alert("Please enter email and password.");

  createUserWithEmailAndPassword(auth, email, password)
    .then(userCred => {
      sendEmailVerification(userCred.user).then(() => {
        show("verify-section");
      });
    })
    .catch(e => alert("Registration error: " + e.message));
};

// ---------- GOOGLE LOGIN ----------
window.googleLogin = async function() {
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    currentUid = user.uid;
    const reqRef = ref(db, "joinRequests/" + currentUid);
    const snapshot = await get(reqRef);

    if (snapshot.exists()) {
      const data = snapshot.val();
      if (data.status === "approved") {
        await handleApprovedUser(reqRef, data);
      } else if (data.status === "pending") {
        show("waiting");
      } else {
        alert("‚ùå Your request was denied.");
        signOut(auth).then(() => show("auth-section"));
      }
    } else {
      show("form-section");
    }
  } catch (e) {
    alert("Google login error: " + e.message);
  }
};

window.reloadAndCheck = function() {
  const user = auth.currentUser;
  if (user) {
    reload(user).then(() => {
      if (user.emailVerified) checkJoinRequest(user);
      else alert("‚ùå Your email is still not verified.");
    });
  }
};

function checkJoinRequest(user) {
  currentUid = user.uid;
  const reqRef = ref(db, "joinRequests/" + currentUid);
  onValue(reqRef, async snapshot => {
    const data = snapshot.val();
    if (!data) show("form-section");
    else if (data.status === "approved") {
      await handleApprovedUser(reqRef, data);
    } else if (data.status === "pending") show("waiting");
    else {
      alert("‚ùå Your request was denied.");
      signOut(auth).then(() => show("auth-section"));
    }
  });
}

// ---------- SUBMIT REQUEST (DUAL WRITE) ----------
window.submitRequest = function() {
  const name = document.getElementById("name").value;
  const reason = document.getElementById("reason").value;
  const user = auth.currentUser;
  if (!name || !reason) return alert("Please fill out all fields.");

  // 1. Create the Request entry (for Admins)
  const requestPromise = set(ref(db, "joinRequests/" + currentUid), {
    name,
    reason,
    email: user.email,
    provider: user.providerData[0]?.providerId || "password",
    status: "pending"
  });

  // 2. Create the User Profile entry (for Profile Page)
  const userProfilePromise = update(ref(db, "users/" + currentUid), {
    name: name,
    email: user.email,
    bio: "New Member"
  });

  Promise.all([requestPromise, userProfilePromise])
    .then(() => {
        show("waiting");
    })
    .catch((error) => {
        console.error("Error saving data:", error);
        alert("Error submitting request. Please try again.");
    });
};

// ---------- LISTENERS ----------
onAuthStateChanged(auth, user => {
  if (user) {
    sessionStorage.setItem("currentUid", user.uid);
    logActivity("login_session", window.location.pathname);
    
    reload(user).then(() => {
      if (user.emailVerified || user.providerData.some(p => p.providerId === "google.com")) {
        checkJoinRequest(user);
      } else show("verify-section");
    });
  } else {
    logActivity("guest_session", window.location.pathname);
    show("auth-section");
  }
});

// Click Logger
document.addEventListener("click", e => {
  const el = e.target;
  if (el && el.tagName) {
    logActivity(`click_${el.tagName.toLowerCase()}`, window.location.pathname);
  }
});

// Page Load Logger
window.addEventListener("load", () => {
  logActivity("page_load", window.location.pathname);
});
</script>

<script>
// Service Worker Registration
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg => {
    reg.onupdatefound = () => {
      const newSW = reg.installing;
      newSW.onstatechange = () => {
        if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
          window.location.reload();
        }
      };
    };
  }).catch(err => {
    console.error('Service Worker registration failed:', err);
  });
}
</script>

</body>
</html>
